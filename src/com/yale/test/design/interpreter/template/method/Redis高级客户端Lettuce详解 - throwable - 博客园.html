<!DOCTYPE html>
<html theme="default" lang="zh-cn"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="never">
    <meta name="description" content="前提 Lettuce是一个Redis的Java驱动包，初识她的时候是使用RedisTemplate的时候遇到点问题Debug到底层的一些源码，发现spring-data-redis的驱动包在某个版本之">
    <meta property="og:description" content="前提 Lettuce是一个Redis的Java驱动包，初识她的时候是使用RedisTemplate的时候遇到点问题Debug到底层的一些源码，发现spring-data-redis的驱动包在某个版本之">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Redis高级客户端Lettuce详解 - throwable - 博客园</title>
    <link id="favicon" rel="shortcut icon" href="https://common.cnblogs.com/favicon.svg" type="image/svg+xml" hre="https://files-cdn.cnblogs.com/files/throwable/favicon.ico">
    
    <link rel="stylesheet" href="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/blog-common.css">
    
    <link type="text/css" rel="stylesheet" href="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/custom.css">
    <link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/bundle-custom-mobile.css">
    
    <link type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/throwable/rss">
    <link type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/throwable/rsd.xml">
    <link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/throwable/wlwmanifest.xml">
    <script src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/hm.txt"></script><script async="" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/analytics.js"></script><script>
        var currentBlogId = 435641;
        var currentBlogApp = 'throwable';
        var cb_enable_mathjax = false;
        var isLogined = false;
        var isBlogOwner = false;
        var skinName = 'Custom';
        var visitorUserId = '';
    </script>
        <script>
            var currentPostDateAdded = '2019-09-28 09:33';
        </script>
    <script src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/jquery-2.js"></script>
    <script src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/blog-common.js"></script>
    
    
    
<link rel="stylesheet" href="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/lightbox.css"></head>
<body class="no-navbar"><svg aria-hidden="true" style="position: absolute; width: 0px; height: 0px; overflow: hidden;"><symbol id="silence-contents" viewBox="0 0 1024 1024"><path d="M64.7 462.3h99.4v99.4H64.7v-99.4zM263.5 462.3h695.9v99.4H263.5v-99.4zM64.7 164.1h99.4v99.4H64.7v-99.4zM263.5 164.1h695.9v99.4H263.5v-99.4zM64.7 760.5h99.4v99.4H64.7v-99.4zM263.5 760.5h695.9v99.4H263.5v-99.4z"></path></symbol><symbol id="silence-skin" viewBox="0 0 1024 1024"><path d="M323.51 159.35h68.78c5.073 3.009 12.47 4.15 17.089 7.732 6.288 4.828 10.807 10.956 15.725 17.234 6.641 8.465 19.171 16.665 29.718 21.079 12.326 5.088 25.41 7.992 40.526 10.797 4.768 0.309 9.535 0.518 14.299 0.828 6.391 0.986 15.525-0.569 20.795-1.659 28.454-5.715 42.709-10.383 61.422-25.231 7.303-5.863 11.21-15.524 18.813-21.129 4.264-2.332 8.574-4.773 12.883-7.159 3.703-1.455 6.343-0.628 9.387-2.491h20.233c19.525 0 48.541-2.65 61.421 4.096 9.077 4.882 16.029 12.565 23.133 19.465 9.89 9.607 19.78 19.212 29.62 28.813 31.895 31.094 63.852 62.139 95.704 93.234 10.044 10.742 21.657 20.039 31.652 30.836 8.211 8.668 16.934 15.16 21.449 27.716 0.154 2.028 0.204 4.051 0.254 6.079 2.282 13.706-3.956 23.67-10.244 31.612-26.73 25.902-53.46 51.86-80.234 77.714-9.741 10.85-21.911 25.957-39.106 29.116-23.437 4.314-36.719-10.12-47.675-20.762-3.552-3.527-6.542-8.04-11.16-10.586-0.199 0.209-0.557 0.413-0.862 0.573v277.726c-0.05 26.058-0.149 52.224-0.298 78.281-1.879 9.038-7.762 18.379-14.205 23.312-16.077 12.147-44.432 9.442-72.88 9.442H367.44c-19.83 0-40.676 1.504-52.544-6.168-6.646-4.155-13.95-11.943-16.895-19.675-3.343-8.933-2.531-21.395-2.531-33.282v-329.95h-1.17c-11.813 10.382-20.896 23.257-36.769 29.749-13.492 5.549-29.267-0.259-37.681-6.079-5.884-4.15-10.348-9.501-15.42-14.428a23254.115 23254.115 0 0 0-36.212-34.682 1874.687 1874.687 0 0 1-17.143-17.282c-7.049-5.919-13.183-12.67-19.675-19.108-7.862-7.682-16.432-13.651-21.15-24.453-2.028-4.569-6.033-12.82-4.564-20.502 3.448-18.22 14.757-27.825 26.272-38.049 6.845-6.024 12.878-13.029 19.674-19.103l113.357-110.417a6278.581 6278.581 0 0 0 20.543-19.984c9.94-9.65 18.813-21.597 37.99-22.216-0.012-0.367-0.012-0.681-0.012-1.039z m0 0"></path></symbol><symbol id="silence-down" viewBox="0 0 1024 1024"><path d="M956.575378 270.45292102L956.575378 270.45292102c-21.974477-21.973454-57.932434-21.973454-79.905888 0L513.291412 633.83099902 147.33051 267.87111902c-21.973454-21.973454-57.931411-21.973454-79.905888 0-21.974477 21.973454-21.974477 57.931411 0 79.905888l398.86122 398.862243c9.325389 9.325389 19.837814 14.054087 32.094976 17.36346 18.262946 2.673899 43.701315 0.847298 59.33027-14.780635l398.862243-398.862243C978.548832 328.38433102 978.548832 292.42637502 956.575378 270.45292102z"></path></symbol><symbol id="silence-up" viewBox="0 0 1024 1024"><path d="M944.9 738.5c20.1-20.1 20.1-52.6 0-72.7L564.7 285.5c-13.6-13.6-33.5-18.4-51.8-12.7-20.2-5.7-40.1-0.9-53.7 12.7L79.1 665.7c-20.1 20.1-20.1 52.6 0 72.7s52.6 20.1 72.7 0l357.9-357.9 362.6 357.9c20 20.1 52.6 20.1 72.6 0.1z"></path></symbol><symbol id="silence-category" viewBox="0 0 1024 1024"><path d="M0.021489 170.681334l0 113.77323 1023.957021 0L1023.978511 170.681334 0.021489 170.681334zM0.021489 568.886615l1023.957021 0L1023.978511 455.113385 0.021489 455.113385 0.021489 568.886615zM0.021489 853.318666l1023.957021 0L1023.978511 739.54646 0.021489 739.54646 0.021489 853.318666z"></path></symbol><symbol id="silence-menu1" viewBox="0 0 1024 1024"><path d="M204.8 614.4c-56.32 0-102.4-46.08-102.4-102.4s46.08-102.4 102.4-102.4 102.4 46.08 102.4 102.4-46.08 102.4-102.4 102.4z m307.2 0c-56.32 0-102.4-46.08-102.4-102.4s46.08-102.4 102.4-102.4 102.4 46.08 102.4 102.4-46.08 102.4-102.4 102.4z m307.2 0c-56.32 0-102.4-46.08-102.4-102.4s46.08-102.4 102.4-102.4 102.4 46.08 102.4 102.4-46.08 102.4-102.4 102.4z"></path></symbol><symbol id="silence-alipay" viewBox="0 0 1024 1024"><path d="M828.571429 624.342857c-44.228571-14.742857-103.657143-37.371429-169.714286-61.257143 39.771429-68.914286 71.428571-147.428571 92.228571-232.685714H533.142857v-78.4h266.971429v-43.771429H533.142857V77.714286h-109.028571c-19.085714 0-19.085714 18.857143-19.085715 18.857143v111.771428H135.085714v43.771429h270.057143v78.4H182.171429v43.771428h432.457142a762.491429 762.491429 0 0 1-62.285714 151.885715c-140.342857-46.171429-290.057143-83.657143-384.114286-60.571429-60.114286 14.857143-98.857143 41.257143-121.714285 68.914286-104.457143 126.857143-29.6 319.542857 191.085714 319.542857C368 853.942857 493.714286 781.257143 591.085714 661.714286 736.342857 731.428571 1024 851.085714 1024 851.085714V680.457143s-36.114286-2.857143-195.428571-56.114286zM217.028571 780.114286c-172 0-222.857143-135.2-137.828571-209.257143 28.342857-25.028571 80.228571-37.257143 107.885714-40 102.171429-10.057143 196.8 28.8 308.457143 83.2-78.628571 102.285714-178.628571 166.057143-278.514286 166.057143z"></path></symbol><symbol id="silence-paypal" viewBox="0 0 1024 1024"><path d="M941.021887 369.059735c7.422144 34.295426 5.703717 73.709573-2.303424 116.524012-37.147285 188.515157-162.263434 253.632592-322.771878 253.632592h-25.154854c-19.414575 0-35.428857 14.295855-38.82915 33.710429l-2.303424 10.859-31.407006 197.655729-1.133431 8.555575c-3.985289 19.414575-19.999572 33.71043-39.414146 33.71043H334.30728c-16.014282 0-26.288285-13.125861-23.984861-29.140144 10.274003-63.984004 19.999572-127.968008 30.273575-191.952012s20.548006-127.383011 30.858571-191.367015c1.718428-13.710858 10.859-21.133002 24.569857-21.133003 22.85143 0 45.70286-0.584997 74.843004 0 41.132574 0.584997 88.553862-1.718428 134.805156-11.99243 61.68058-13.710858 117.694005-38.82915 163.945299-82.265148 41.717571-38.82915 69.687721-86.835434 88.553862-140.545435a515.893884 515.893884 0 0 0 19.999571-75.976435c1.133431-6.837148 2.851858-5.703717 6.837148-2.851858 31.407005 23.436427 49.139715 54.843432 55.976863 92.539151z m-98.242867-161.093441c0 46.836291-10.859 91.40572-26.288286 134.805156-29.688578 86.250437-85.702003 147.96758-172.537437 179.959582-46.287857 16.562716-94.842575 23.436427-143.98229 23.98486-34.295426 0.584997-68.55429 0-102.813154 0-37.147285 0-60.547149 18.281144-67.420859 54.843432-8.007141 43.435998-39.414146 245.662013-48.554718 302.772307-0.584997 3.985289-2.303424 5.703717-6.837148 5.703717H105.829543a27.494841 27.494841 0 0 1-27.421716-31.407005L210.946121 38.280716A45.995358 45.995358 0 0 1 256.063984 0h341.638019c24.569858 0 81.131717 10.859 119.412433 25.703288 81.131717 31.407005 125.664584 95.391009 125.664584 182.226444z" fill=""></path></symbol><symbol id="silence-wechat" viewBox="0 0 1024 1024"><path d="M1004.416 543.914667c-25.984-58.88-75.008-105.642667-131.925333-134.442667-100.437333-50.858667-225.322667-50.56-325.504 1.28-69.589333 35.712-127.701333 99.712-144.170667 177.578667-13.568 57.344-1.408 119.082667 29.013333 169.002666 45.269333 75.178667 127.104 123.178667 212.096 138.581334 61.568 12.501333 125.269333 5.077333 185.088-12.16 35.925333 13.909333 67.925333 36.437333 102.741334 53.162666a2238.762667 2238.762667 0 0 0-28.842667-89.685333c39.082667-27.733333 74.496-62.336 95.744-105.770667 31.744-60.373333 33.664-135.296 5.76-197.546666z m-423.424-403.882667c-106.453333-59.904-239.018667-68.906667-353.536-27.52-75.264 27.093333-143.36 77.44-185.429333 145.92-38.186667 61.866667-52.48 139.008-34.090667 209.792 18.474667 78.506667 73.002667 144.341333 139.178667 188.288-12.8 36.266667-24.96 72.490667-36.48 109.013333 41.6-21.76 83.2-44.501333 124.842666-66.602666 49.92 16 103.04 23.850667 156.16 22.101333a262.784 262.784 0 0 1-10.88-125.909333c9.6-58.496 41.6-112 85.077334-151.637334 73.642667-68.906667 177.962667-97.962667 277.162666-90.922666-18.602667-91.093333-82.602667-168.064-163.157333-212.48h1.152z m73.941333 426.197333c-8.917333 27.818667-49.322667 36.181333-68.906666 15.018667-21.589333-19.584-13.184-60.501333 15.146666-69.248 31.317333-13.226667 67.498667 22.912 53.76 54.229333z m204.586667 3.925334c-10.922667 25.002667-48.682667 30.848-67.242667 11.52-8.917333-8.149333-11.52-20.437333-14.677333-31.146667 4.437333-19.541333 17.92-39.808 39.68-40.746667 30.08-4.181333 57.002667 32.981333 41.6 60.416h0.64zM554.24 294.784c0.341333 41.002667-54.4 66.602667-85.12 38.784-31.872-22.826667-22.826667-78.378667 14.592-89.856 33.493333-13.44 73.088 14.677333 70.442667 50.56l0.085333 0.512z m-258.517333 10.410667c-7.338667 35.626667-55.082667 52.821333-83.029334 28.928-32.384-22.826667-23.296-79.402667 14.72-90.922667 37.248-14.336 79.573333 23.466667 68.309334 61.994667z" fill=""></path></symbol></svg><div class="esa-mobile-menu"></div>
    <a name="top"></a> 
    <div id="top_nav" class="navbar navbar-custom">
        <nav id="nav_main" class="navbar-main">
            <ul id="nav_left" class="navbar-list navbar-left">
                <li class="navbar-branding">
                    <a href="https://www.cnblogs.com/" title="开发者的网上家园"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/logo.svg" alt="博客园Logo"></a>
                </li>
                <li><a href="https://www.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-sitehome')">首页</a></li>
                <li><a href="https://news.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-news')">新闻</a></li>
                <li><a href="https://q.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-q')">博问</a></li>
                <li><a id="nav_brandzone" href="https://brands.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-brands')">专区</a></li>
                <li><a href="https://ing.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-ing')">闪存</a></li>
                <li><a href="https://edu.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'skin-navbar-edu')">班级</a></li>
            </ul>
            <ul id="nav_right" class="navbar-list navbar-right">
                <li>
                    <form id="zzk_search" class="navbar-search" action="https://zzk.cnblogs.com/s" method="get">
                        <input name="w" id="zzk_search_input" placeholder="代码改变世界" type="text" tabindex="3">
                        <button type="submit" id="zzk_search_button">
                            <img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/search.svg" alt="搜索">
                        </button>
                    </form>
                </li>
                <li id="navbar_login_status" class="navbar-list">
                    <a id="navblog-myblog-icon" class="navbar-user-info navbar-blog" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx" alt="我的博客" title="我的博客" style="display: none;">
                        <img id="myblog_icon" class="navbar-icon" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/myblog.svg" alt="我的博客">
                    </a>
                    <a class="navbar-user-info navbar-message navbar-icon-wrapper" href="https://msg.cnblogs.com/" alt="短消息" title="短消息" style="display: none;">
                        <img id="msg_icon" class="navbar-icon" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/message.svg" alt="短消息">
                        <span id="msg_count" style="display: none"></span>
                    </a>
                    <div id="user_info" class="navbar-user-info dropdown" style="display: none;">
                        <a class="dropdown-button" href="https://home.cnblogs.com/">
                            <img id="user_icon" class="navbar-avatar" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/avatar-default.svg" alt="用户头像">
                        </a>
                        <div class="dropdown-menu">
                            <a id="navblog-myblog-text" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx">我的博客</a>
                            <a href="https://home.cnblogs.com/">我的园子</a>
                            <a href="https://account.cnblogs.com/settings/account">账号设置</a>
                            <a href="javascript:void(0)" onclick="logout();">退出登录</a>
                        </div>
                    </div>
                    <a class="navbar-anonymous" href="https://account.cnblogs.com/signup/" style="display: inline;">注册</a>
                    <a class="navbar-anonymous" href="https://account.cnblogs.com/signin/?returnUrl=https://www.cnblogs.com/" style="display: inline;">登录</a>
                </li>
            </ul>
        </nav>
    </div>

    
    <!--done-->
<div id="home">
<div id="header" style="display: block;">
	<div id="blogTitle">
        <a id="lnkBlogLogo" href="https://www.cnblogs.com/throwable/"><img id="blogLogo" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/logo.gif" alt="返回主页"></a>		
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle HeaderMainTitle" href="https://www.cnblogs.com/throwable/">Throwable</a>
</h1>
<h2>

</h2>




		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">

<li>
<a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/throwable/">
首页</a>
<i></i></li><li><a class="menu" href="https://www.throwx.cn/">个人博客</a><i></i></li><li><a class="menu" href="https://mp.weixin.qq.com/s/zRvT46NeCYaJOsHcucro3w">公众号</a><i></i></li><li><a class="menu" href="https://www.cnblogs.com/throwable/p/">归档</a><i></i></li><li><a class="menu" href="https://www.cnblogs.com/throwable/tag/">标签</a><i></i></li><li><a class="menu" href="https://github.com/zjcscut">Github</a><i></i></li>

<li>
<a id="blog_nav_contact" class="menu" href="https://msg.cnblogs.com/send/throwable">
联系</a><i></i></li>
<li>
<a id="blog_nav_rss" class="menu" href="javascript:void(0)" data-rss="https://www.cnblogs.com/throwable/rss/">
订阅</a>
<!--<partial name="./Shared/_XmlLink.cshtml" model="Model" /></li>--><i></i></li>
<li>
<a id="blog_nav_admin" class="menu" href="https://i.cnblogs.com/">
管理</a>
<i></i></li>
</ul>


		<div class="blogStats">
			<span id="stats_post_count">随笔 - 
96&nbsp; </span>
<span id="stats_article_count">文章 - 
0&nbsp; </span>
<span id="stats-comment_count">评论 - 
82</span>

		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		<div id="post_detail">
    <!--done-->
    <div id="topics">
        <div class="post">
            <h1 class="postTitle">
                
<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/throwable/p/11601538.html">
    <span>Redis高级客户端Lettuce详解</span>
    


</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
    <h2 id="前提">前提<a href="#前提" class="esa-anchor" style="opacity: 0;">#</a></h2>
<p><code>Lettuce</code>是一个<code>Redis</code>的<code>Java</code>驱动包，初识她的时候是使用<code>RedisTemplate</code>的时候遇到点问题<code>Debug</code>到底层的一些源码，发现<code>spring-data-redis</code>的驱动包在某个版本之后替换为<code>Lettuce</code>。<code>Lettuce</code>翻译为<strong>生菜</strong>，没错，就是吃的那种生菜，所以它的<code>Logo</code>长这样：</p>
<p><a href="https://img2018.cnblogs.com/blog/1412331/201909/1412331-20190928093229322-1599957688.png" data-title="" data-alt="" data-lightbox="roadtrip"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/1412331-20190928093229322-1599957688.png" alt="" loading="lazy"></a></p>
<p>既然能被<code>Spring</code>生态所认可，<code>Lettuce</code>想必有过人之处，于是笔者花时间阅读她的官方文档，整理测试示例，写下这篇文章。编写本文时所使用的版本为<code>Lettuce 5.1.8.RELEASE</code>，<code>SpringBoot 2.1.8.RELEASE</code>，<code>JDK [8,11]</code>。<font color="red">超长警告</font>：这篇文章断断续续花了两周完成，超过4万字.....</p>
<h2 id="lettuce简介">Lettuce简介<a href="#lettuce简介" class="esa-anchor" style="opacity: 0;">#</a></h2>
<p><code>Lettuce</code>是一个高性能基于<code>Java</code>编写的<code>Redis</code>驱动框架，底层集成了<code>Project Reactor</code>提供天然的反应式编程，通信框架集成了<code>Netty</code>使用了非阻塞<code>IO</code>，<code>5.x</code>版本之后融合了<code>JDK1.8</code>的异步编程特性，在保证高性能的同时提供了十分丰富易用的<code>API</code>，<code>5.1</code>版本的新特性如下：</p>
<ul>
<li>支持<code>Redis</code>的新增命令<code>ZPOPMIN, ZPOPMAX, BZPOPMIN, BZPOPMAX</code>。</li>
<li>支持通过<code>Brave</code>模块跟踪<code>Redis</code>命令执行。</li>
<li>支持<code>Redis Streams</code>。</li>
<li>支持异步的主从连接。</li>
<li>支持异步连接池。</li>
<li>新增命令最多执行一次模式（禁止自动重连）。</li>
<li>全局命令超时设置（对异步和反应式命令也有效）。</li>
<li>......等等</li>
</ul>
<p><strong>注意一点</strong>：<code>Redis</code>的版本至少需要<code>2.6</code>，当然越高越好，<code>API</code>的兼容性比较强大。</p>
<p>只需要引入单个依赖就可以开始愉快地使用<code>Lettuce</code>：</p>
<ul>
<li>Maven</li>
</ul>
<pre><code class="language-xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.lettuce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lettuce-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ul>
<li>Gradle</li>
</ul>
<pre><code class="language-shell hljs">dependencies {
  compile 'io.lettuce:lettuce-core:5.1.8.RELEASE'
}
</code></pre>
<h2 id="连接redis">连接Redis<a href="#连接redis" class="esa-anchor">#</a></h2>
<p>单机、哨兵、集群模式下连接<code>Redis</code>需要一个统一的标准去表示连接的细节信息，在<code>Lettuce</code>中这个统一的标准是<code>RedisURI</code>。可以通过三种方式构造一个<code>RedisURI</code>实例：</p>
<ul>
<li>定制的字符串<code>URI</code>语法：</li>
</ul>
<pre><code class="language-java hljs">RedisURI uri = RedisURI.create(<span class="hljs-string">"redis://localhost/"</span>);
</code></pre>
<ul>
<li>使用建造器（<code>RedisURI.Builder</code>）：</li>
</ul>
<pre><code class="language-java hljs">RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"localhost"</span>).withPort(<span class="hljs-number">6379</span>).build();
</code></pre>
<ul>
<li>直接通过构造函数实例化：</li>
</ul>
<pre><code class="language-java hljs">RedisURI uri = <span class="hljs-keyword">new</span> RedisURI(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
</code></pre>
<h3 id="定制的连接uri语法">定制的连接URI语法<a href="#定制的连接uri语法" class="esa-anchor">#</a></h3>
<ul>
<li>单机（前缀为<code>redis://</code>）</li>
</ul>
<pre><code class="language-shell hljs">格式：redis://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]
完整：redis://mypassword@127.0.0.1:6379/0?timeout=10s
简单：redis://localhost
</code></pre>
<ul>
<li>单机并且使用<code>SSL</code>（前缀为<code>rediss://</code>）  &lt;== 注意后面多了个<code>s</code></li>
</ul>
<pre><code class="language-shell hljs">格式：rediss://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]
完整：rediss://mypassword@127.0.0.1:6379/0?timeout=10s
简单：rediss://localhost
</code></pre>
<ul>
<li>单机<code>Unix Domain Sockets</code>模式（前缀为<code>redis-socket://</code>）</li>
</ul>
<pre><code class="language-shell hljs">格式：redis-socket://path[?[timeout=timeout[d|h|m|s|ms|us|ns]][&amp;_database=database_]]
完整：redis-socket:///tmp/redis?timeout=10s&amp;_database=0
</code></pre>
<ul>
<li>哨兵（前缀为<code>redis-sentinel://</code>）</li>
</ul>
<pre><code class="language-shell hljs">格式：redis-sentinel://[password@]host[:port][,host2[:port2]][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]#sentinelMasterId
完整：redis-sentinel://mypassword@127.0.0.1:6379,127.0.0.1:6380/0?timeout=10s#mymaster
</code></pre>
<p>超时时间单位：</p>
<ul>
<li>d 天</li>
<li>h 小时</li>
<li>m 分钟</li>
<li>s 秒钟</li>
<li>ms 毫秒</li>
<li>us 微秒</li>
<li>ns 纳秒</li>
</ul>
<p>个人建议使用<code>RedisURI</code>提供的建造器，毕竟定制的<code>URI</code>虽然简洁，但是比较容易出现人为错误。鉴于笔者没有<code>SSL</code>和<code>Unix Domain Socket</code>的使用场景，下面不对这两种连接方式进行列举。</p>
<h3 id="基本使用">基本使用<a href="#基本使用" class="esa-anchor">#</a></h3>
<p><code>Lettuce</code>使用的时候依赖于四个主要组件：</p>
<ul>
<li><code>RedisURI</code>：连接信息。</li>
<li><code>RedisClient</code>：<code>Redis</code>客户端，特殊地，集群连接有一个定制的<code>RedisClusterClient</code>。</li>
<li><code>Connection</code>：<code>Redis</code>连接，主要是<code>StatefulConnection</code>或者<code>StatefulRedisConnection</code>的子类，连接的类型主要由连接的具体方式（单机、哨兵、集群、订阅发布等等）选定，比较重要。</li>
<li><code>RedisCommands</code>：<code>Redis</code>命令<code>API</code>接口，<strong>基本上覆盖了<code>Redis</code>发行版本的所有命令</strong>，提供了同步（<code>sync</code>）、异步（<code>async</code>）、反应式（<code>reative</code>）的调用方式，对于使用者而言，会经常跟<code>RedisCommands</code>系列接口打交道。</li>
</ul>
<p>一个基本使用例子如下：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetGet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()                    <span class="hljs-comment">// &lt;1&gt; 创建单机连接的连接信息</span>
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);   <span class="hljs-comment">// &lt;2&gt; 创建客户端</span>
    StatefulRedisConnection&lt;String, String&gt; connection = redisClient.connect();     <span class="hljs-comment">// &lt;3&gt; 创建线程安全的连接</span>
    RedisCommands&lt;String, String&gt; redisCommands = connection.sync();                <span class="hljs-comment">// &lt;4&gt; 创建同步命令</span>
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    String result = redisCommands.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs);
    Assertions.assertThat(result).isEqualToIgnoringCase(<span class="hljs-string">"OK"</span>);
    result = redisCommands.get(<span class="hljs-string">"name"</span>);
    Assertions.assertThat(result).isEqualTo(<span class="hljs-string">"throwable"</span>);
    <span class="hljs-comment">// ... 其他操作</span>
    connection.close();   <span class="hljs-comment">// &lt;5&gt; 关闭连接</span>
    redisClient.shutdown();  <span class="hljs-comment">// &lt;6&gt; 关闭客户端</span>
}
</code></pre>
<p>注意：</p>
<ul>
<li><strong>&lt;5&gt;</strong>：关闭连接一般在应用程序停止之前操作，一个应用程序中的一个<code>Redis</code>驱动实例不需要太多的连接（一般情况下只需要一个连接实例就可以，如果有多个连接的需要可以考虑使用连接池，其实<code>Redis</code>目前处理命令的模块是单线程，在客户端多个连接多线程调用理论上没有效果）。</li>
<li><strong>&lt;6&gt;</strong>：关闭客户端一般应用程序停止之前操作，如果条件允许的话，基于<strong>后开先闭</strong>原则，客户端关闭应该在连接关闭之后操作。</li>
</ul>
<h2 id="api">API<a href="#api" class="esa-anchor">#</a></h2>
<p><code>Lettuce</code>主要提供三种<code>API</code>：</p>
<ul>
<li>同步（<code>sync</code>）：<code>RedisCommands</code>。</li>
<li>异步（<code>async</code>）：<code>RedisAsyncCommands</code>。</li>
<li>反应式（<code>reactive</code>）：<code>RedisReactiveCommands</code>。</li>
</ul>
<p>先准备好一个单机<code>Redis</code>连接备用：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> StatefulRedisConnection&lt;String, String&gt; CONNECTION;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedisClient CLIENT;

<span class="hljs-meta">@BeforeClass</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeClass</span><span class="hljs-params">()</span> </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    CLIENT = RedisClient.create(redisUri);
    CONNECTION = CLIENT.connect();
}

<span class="hljs-meta">@AfterClass</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    CONNECTION.close();
    CLIENT.shutdown();
}
</code></pre>
<p><code>Redis</code>命令<code>API</code>的具体实现可以直接从<code>StatefulRedisConnection</code>实例获取，见其接口定义：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StatefulRedisConnection</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulConnection</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>{

    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isMulti</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">RedisCommands&lt;K, V&gt; <span class="hljs-title">sync</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">RedisAsyncCommands&lt;K, V&gt; <span class="hljs-title">async</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">RedisReactiveCommands&lt;K, V&gt; <span class="hljs-title">reactive</span><span class="hljs-params">()</span></span>;
}    
</code></pre>
<p>值得注意的是，在不指定编码解码器<code>RedisCodec</code>的前提下，<code>RedisClient</code>创建的<code>StatefulRedisConnection</code>实例一般是泛型实例<code>StatefulRedisConnection&lt;String,String&gt;</code>，也就是所有命令<code>API</code>的<code>KEY</code>和<code>VALUE</code>都是<code>String</code>类型，这种使用方式能满足大部分的使用场景。当然，必要的时候可以定制编码解码器<code>RedisCodec&lt;K,V&gt;</code>。</p>
<h3 id="同步api">同步API<a href="#同步api" class="esa-anchor">#</a></h3>
<p>先构建<code>RedisCommands</code>实例：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedisCommands&lt;String, String&gt; COMMAND;

<span class="hljs-meta">@BeforeClass</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeClass</span><span class="hljs-params">()</span> </span>{
    COMMAND = CONNECTION.sync();
}
</code></pre>
<p>基本使用：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncPing</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
   String pong = COMMAND.ping();
   Assertions.assertThat(pong).isEqualToIgnoringCase(<span class="hljs-string">"PONG"</span>);
}


<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncSetAndGet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    COMMAND.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs);
    String value = COMMAND.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value: {}"</span>, value);
}

<span class="hljs-comment">// Get value: throwable</span>
</code></pre>
<p>同步<code>API</code>在所有命令调用之后会立即返回结果。如果熟悉<code>Jedis</code>的话，<code>RedisCommands</code>的用法其实和它相差不大。</p>
<h3 id="异步api">异步API<a href="#异步api" class="esa-anchor">#</a></h3>
<p>先构建<code>RedisAsyncCommands</code>实例：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedisAsyncCommands&lt;String, String&gt; ASYNC_COMMAND;

<span class="hljs-meta">@BeforeClass</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeClass</span><span class="hljs-params">()</span> </span>{
    ASYNC_COMMAND = CONNECTION.async();
}
</code></pre>
<p>基本使用：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAsyncPing</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisFuture&lt;String&gt; redisFuture = ASYNC_COMMAND.ping();
    log.info(<span class="hljs-string">"Ping result:{}"</span>, redisFuture.get());
}
<span class="hljs-comment">// Ping result:PONG</span>
</code></pre>
<p><code>RedisAsyncCommands</code>所有方法执行返回结果都是<code>RedisFuture</code>实例，而<code>RedisFuture</code>接口的定义如下：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RedisFuture</span>&lt;<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">CompletionStage</span>&lt;<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Future</span>&lt;<span class="hljs-title">V</span>&gt; </span>{

    <span class="hljs-function">String <span class="hljs-title">getError</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">await</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;
}    
</code></pre>
<p>也就是，<code>RedisFuture</code>可以无缝使用<code>Future</code>或者<code>JDK</code>1.8中引入的<code>CompletableFuture</code>提供的方法。举个例子：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAsyncSetAndGet1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    RedisFuture&lt;String&gt; future = ASYNC_COMMAND.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs);
    <span class="hljs-comment">// CompletableFuture#thenAccept()</span>
    future.thenAccept(value -&gt; log.info(<span class="hljs-string">"Set命令返回:{}"</span>, value));
    <span class="hljs-comment">// Future#get()</span>
    future.get();
}
<span class="hljs-comment">// Set命令返回:OK</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAsyncSetAndGet2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    CompletableFuture&lt;Void&gt; result =
            (CompletableFuture&lt;Void&gt;) ASYNC_COMMAND.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs)
                    .thenAcceptBoth(ASYNC_COMMAND.get(<span class="hljs-string">"name"</span>),
                            (s, g) -&gt; {
                                log.info(<span class="hljs-string">"Set命令返回:{}"</span>, s);
                                log.info(<span class="hljs-string">"Get命令返回:{}"</span>, g);
                            });
    result.get();
}
<span class="hljs-comment">// Set命令返回:OK</span>
<span class="hljs-comment">// Get命令返回:throwable</span>
</code></pre>
<p>如果能熟练使用<code>CompletableFuture</code>和函数式编程技巧，可以组合多个<code>RedisFuture</code>完成一些列复杂的操作。</p>
<h3 id="反应式api">反应式API<a href="#反应式api" class="esa-anchor">#</a></h3>
<p><code>Lettuce</code>引入的反应式编程框架是<a href="https://projectreactor.io/">Project Reactor</a>，如果没有反应式编程经验可以先自行了解一下<code>Project Reactor</code>。</p>
<p>构建<code>RedisReactiveCommands</code>实例：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedisReactiveCommands&lt;String, String&gt; REACTIVE_COMMAND;

<span class="hljs-meta">@BeforeClass</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeClass</span><span class="hljs-params">()</span> </span>{
    REACTIVE_COMMAND = CONNECTION.reactive();
}
</code></pre>
<p>根据<code>Project Reactor</code>，<code>RedisReactiveCommands</code>的方法如果返回的结果只包含0或1个元素，那么返回值类型是<code>Mono</code>，如果返回的结果包含0到N（N大于0）个元素，那么返回值是<code>Flux</code>。举个例子：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReactivePing</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    Mono&lt;String&gt; ping = REACTIVE_COMMAND.ping();
    ping.subscribe(v -&gt; log.info(<span class="hljs-string">"Ping result:{}"</span>, v));
    Thread.sleep(<span class="hljs-number">1000</span>);
}
<span class="hljs-comment">// Ping result:PONG</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReactiveSetAndGet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    REACTIVE_COMMAND.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs).block();
    REACTIVE_COMMAND.get(<span class="hljs-string">"name"</span>).subscribe(value -&gt; log.info(<span class="hljs-string">"Get命令返回:{}"</span>, value));
    Thread.sleep(<span class="hljs-number">1000</span>);
}
<span class="hljs-comment">// Get命令返回:throwable</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReactiveSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    REACTIVE_COMMAND.sadd(<span class="hljs-string">"food"</span>, <span class="hljs-string">"bread"</span>, <span class="hljs-string">"meat"</span>, <span class="hljs-string">"fish"</span>).block();
    Flux&lt;String&gt; flux = REACTIVE_COMMAND.smembers(<span class="hljs-string">"food"</span>);
    flux.subscribe(log::info);
    REACTIVE_COMMAND.srem(<span class="hljs-string">"food"</span>, <span class="hljs-string">"bread"</span>, <span class="hljs-string">"meat"</span>, <span class="hljs-string">"fish"</span>).block();
    Thread.sleep(<span class="hljs-number">1000</span>);
}
<span class="hljs-comment">// meat</span>
<span class="hljs-comment">// bread</span>
<span class="hljs-comment">// fish</span>
</code></pre>
<p>举个更加复杂的例子，包含了事务、函数转换等：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReactiveFunctional</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    REACTIVE_COMMAND.multi().doOnSuccess(r -&gt; {
        REACTIVE_COMMAND.set(<span class="hljs-string">"counter"</span>, <span class="hljs-string">"1"</span>).doOnNext(log::info).subscribe();
        REACTIVE_COMMAND.incr(<span class="hljs-string">"counter"</span>).doOnNext(c -&gt; log.info(String.valueOf(c))).subscribe();
    }).flatMap(s -&gt; REACTIVE_COMMAND.exec())
            .doOnNext(transactionResult -&gt; log.info(<span class="hljs-string">"Discarded:{}"</span>, transactionResult.wasDiscarded()))
            .subscribe();
    Thread.sleep(<span class="hljs-number">1000</span>);
}
<span class="hljs-comment">// OK</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// Discarded:false</span>
</code></pre>
<p>这个方法开启一个事务，先把<code>counter</code>设置为1，再将<code>counter</code>自增1。</p>
<h3 id="发布和订阅">发布和订阅<a href="#发布和订阅" class="esa-anchor">#</a></h3>
<p>非集群模式下的发布订阅依赖于定制的连接<code>StatefulRedisPubSubConnection</code>，集群模式下的发布订阅依赖于定制的连接<code>StatefulRedisClusterPubSubConnection</code>，两者分别来源于<code>RedisClient#connectPubSub()</code>系列方法和<code>RedisClusterClient#connectPubSub()</code>：</p>
<ul>
<li>非集群模式：</li>
</ul>
<pre><code class="language-java hljs"><span class="hljs-comment">// 可能是单机、普通主从、哨兵等非集群模式的客户端</span>
RedisClient client = ...
StatefulRedisPubSubConnection&lt;String, String&gt; connection = client.connectPubSub();
connection.addListener(<span class="hljs-keyword">new</span> RedisPubSubListener&lt;String, String&gt;() { ... });

<span class="hljs-comment">// 同步命令</span>
RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();
sync.subscribe(<span class="hljs-string">"channel"</span>);

<span class="hljs-comment">// 异步命令</span>
RedisPubSubAsyncCommands&lt;String, String&gt; async = connection.async();
RedisFuture&lt;Void&gt; future = async.subscribe(<span class="hljs-string">"channel"</span>);

<span class="hljs-comment">// 反应式命令</span>
RedisPubSubReactiveCommands&lt;String, String&gt; reactive = connection.reactive();
reactive.subscribe(<span class="hljs-string">"channel"</span>).subscribe();

reactive.observeChannels().doOnNext(patternMessage -&gt; {...}).subscribe()
</code></pre>
<ul>
<li>集群模式：</li>
</ul>
<pre><code class="language-java hljs"><span class="hljs-comment">// 使用方式其实和非集群模式基本一致</span>
RedisClusterClient clusterClient = ...
StatefulRedisClusterPubSubConnection&lt;String, String&gt; connection = clusterClient.connectPubSub();
connection.addListener(<span class="hljs-keyword">new</span> RedisPubSubListener&lt;String, String&gt;() { ... });
RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();
sync.subscribe(<span class="hljs-string">"channel"</span>);
<span class="hljs-comment">// ...</span>
</code></pre>
<p>这里用单机同步命令的模式举一个<code>Redis</code>键空间通知（<a href="https://redis.io/topics/notifications">Redis Keyspace Notifications</a>）的例子：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncKeyspaceNotification</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            <span class="hljs-comment">// 注意这里只能是0号库</span>
            .withDatabase(<span class="hljs-number">0</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);
    StatefulRedisConnection&lt;String, String&gt; redisConnection = redisClient.connect();
    RedisCommands&lt;String, String&gt; redisCommands = redisConnection.sync();
    <span class="hljs-comment">// 只接收键过期的事件</span>
    redisCommands.configSet(<span class="hljs-string">"notify-keyspace-events"</span>, <span class="hljs-string">"Ex"</span>);
    StatefulRedisPubSubConnection&lt;String, String&gt; connection = redisClient.connectPubSub();
    connection.addListener(<span class="hljs-keyword">new</span> RedisPubSubAdapter&lt;&gt;() {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">psubscribed</span><span class="hljs-params">(String pattern, <span class="hljs-keyword">long</span> count)</span> </span>{
            log.info(<span class="hljs-string">"pattern:{},count:{}"</span>, pattern, count);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">message</span><span class="hljs-params">(String pattern, String channel, String message)</span> </span>{
            log.info(<span class="hljs-string">"pattern:{},channel:{},message:{}"</span>, pattern, channel, message);
        }
    });
    RedisPubSubCommands&lt;String, String&gt; commands = connection.sync();
    commands.psubscribe(<span class="hljs-string">"__keyevent@0__:expired"</span>);
    redisCommands.setex(<span class="hljs-string">"name"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"throwable"</span>);
    Thread.sleep(<span class="hljs-number">10000</span>);
    redisConnection.close();
    connection.close();
    redisClient.shutdown();
}
<span class="hljs-comment">// pattern:__keyevent@0__:expired,count:1</span>
<span class="hljs-comment">// pattern:__keyevent@0__:expired,channel:__keyevent@0__:expired,message:name</span>
</code></pre>
<p>实际上，在实现<code>RedisPubSubListener</code>的时候可以单独抽离，尽量不要设计成匿名内部类的形式。</p>
<h3 id="事务和批量命令执行">事务和批量命令执行<a href="#事务和批量命令执行" class="esa-anchor" style="opacity: 0;">#</a></h3>
<p>事务相关的命令就是<code>WATCH</code>、<code>UNWATCH</code>、<code>EXEC</code>、<code>MULTI</code>和<code>DISCARD</code>，在<code>RedisCommands</code>系列接口中有对应的方法。举个例子：</p>
<pre><code class="language-java hljs"><span class="hljs-comment">// 同步模式</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncMulti</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    COMMAND.multi();
    COMMAND.setex(<span class="hljs-string">"name-1"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"throwable"</span>);
    COMMAND.setex(<span class="hljs-string">"name-2"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"doge"</span>);
    TransactionResult result = COMMAND.exec();
    <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (Object r : result) {
        log.info(<span class="hljs-string">"Result-{}:{}"</span>, index, r);
        index++;
    }
}
<span class="hljs-comment">// Result-0:OK</span>
<span class="hljs-comment">// Result-1:OK</span>
</code></pre>
<p><code>Redis</code>的<code>Pipeline</code>也就是管道机制可以理解为把多个命令打包在一次请求发送到<code>Redis</code>服务端，然后<code>Redis</code>服务端把所有的响应结果打包好一次性返回，从而节省不必要的网络资源（最主要是减少网络请求次数）。<code>Redis</code>对于<code>Pipeline</code>机制如何实现并没有明确的规定，也没有提供特殊的命令支持<code>Pipeline</code>机制。<code>Jedis</code>中底层采用<code>BIO</code>（阻塞IO）通讯，所以它的做法是客户端缓存将要发送的命令，最后需要触发然后同步发送一个巨大的命令列表包，再接收和解析一个巨大的响应列表包。<code>Pipeline</code>在<code>Lettuce</code>中对使用者是透明的，由于底层的通讯框架是<code>Netty</code>，所以网络通讯层面的优化<code>Lettuce</code>不需要过多干预，换言之可以这样理解：<code>Netty</code>帮<code>Lettuce</code>从底层实现了<code>Redis</code>的<code>Pipeline</code>机制。但是，<code>Lettuce</code>的异步<code>API</code>也提供了手动<code>Flush</code>的方法：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAsyncManualFlush</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 取消自动flush</span>
    ASYNC_COMMAND.setAutoFlushCommands(<span class="hljs-keyword">false</span>);
    List&lt;RedisFuture&lt;?&gt;&gt; redisFutures = Lists.newArrayList();
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">5000</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        String key = <span class="hljs-string">"key-"</span> + (i + <span class="hljs-number">1</span>);
        String value = <span class="hljs-string">"value-"</span> + (i + <span class="hljs-number">1</span>);
        redisFutures.add(ASYNC_COMMAND.set(key, value));
        redisFutures.add(ASYNC_COMMAND.expire(key, <span class="hljs-number">2</span>));
    }
    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();
    ASYNC_COMMAND.flushCommands();
    <span class="hljs-keyword">boolean</span> result = LettuceFutures.awaitAll(<span class="hljs-number">10</span>, TimeUnit.SECONDS, redisFutures.toArray(<span class="hljs-keyword">new</span> RedisFuture[<span class="hljs-number">0</span>]));
    Assertions.assertThat(result).isTrue();
    log.info(<span class="hljs-string">"Lettuce cost:{} ms"</span>, System.currentTimeMillis() - start);
}
<span class="hljs-comment">// Lettuce cost:1302 ms</span>
</code></pre>
<p>上面只是从文档看到的一些理论术语，但是现实是骨感的，对比了下<code>Jedis</code>的<code>Pipeline</code>提供的方法，发现了<code>Jedis</code>的<code>Pipeline</code>执行耗时比较低：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testJedisPipeline</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    Jedis jedis = <span class="hljs-keyword">new</span> Jedis();
    Pipeline pipeline = jedis.pipelined();
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">5000</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        String key = <span class="hljs-string">"key-"</span> + (i + <span class="hljs-number">1</span>);
        String value = <span class="hljs-string">"value-"</span> + (i + <span class="hljs-number">1</span>);
        pipeline.set(key, value);
        pipeline.expire(key, <span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();
    pipeline.syncAndReturnAll();
    log.info(<span class="hljs-string">"Jedis cost:{} ms"</span>, System.currentTimeMillis()  - start);
}
<span class="hljs-comment">// Jedis cost:9 ms</span>
</code></pre>
<p>个人猜测<code>Lettuce</code>可能底层并非合并所有命令一次发送（甚至可能是单条发送），具体可能需要抓包才能定位。依此来看，如果真的有大量执行<code>Redis</code>命令的场景，不妨可以使用<code>Jedis</code>的<code>Pipeline</code>。</p>
<p><strong>注意</strong>：由上面的测试推断<code>RedisTemplate</code>的<code>executePipelined()</code>方法是<strong><font color="red">假的</font></strong><code>Pipeline</code>执行方法，使用<code>RedisTemplate</code>的时候请务必注意这一点。</p>
<h3 id="lua脚本执行">Lua脚本执行<a href="#lua脚本执行" class="esa-anchor">#</a></h3>
<p><code>Lettuce</code>中执行<code>Redis</code>的<code>Lua</code>命令的同步接口如下：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RedisScriptingCommands</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>{

    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">eval</span><span class="hljs-params">(String var1, ScriptOutputType var2, K... var3)</span></span>;

    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">eval</span><span class="hljs-params">(String var1, ScriptOutputType var2, K[] var3, V... var4)</span></span>;

    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">evalsha</span><span class="hljs-params">(String var1, ScriptOutputType var2, K... var3)</span></span>;

    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">evalsha</span><span class="hljs-params">(String var1, ScriptOutputType var2, K[] var3, V... var4)</span></span>;

    <span class="hljs-function">List&lt;Boolean&gt; <span class="hljs-title">scriptExists</span><span class="hljs-params">(String... var1)</span></span>;

    <span class="hljs-function">String <span class="hljs-title">scriptFlush</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">String <span class="hljs-title">scriptKill</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function">String <span class="hljs-title">scriptLoad</span><span class="hljs-params">(V var1)</span></span>;

    <span class="hljs-function">String <span class="hljs-title">digest</span><span class="hljs-params">(V var1)</span></span>;
}
</code></pre>
<p>异步和反应式的接口方法定义差不多，不同的地方就是返回值类型，一般我们常用的是<code>eval()</code>、<code>evalsha()</code>和<code>scriptLoad()</code>方法。举个简单的例子：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedisCommands&lt;String, String&gt; COMMANDS;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String RAW_LUA = <span class="hljs-string">"local key = KEYS[1]\n"</span> +
        <span class="hljs-string">"local value = ARGV[1]\n"</span> +
        <span class="hljs-string">"local timeout = ARGV[2]\n"</span> +
        <span class="hljs-string">"redis.call('SETEX', key, tonumber(timeout), value)\n"</span> +
        <span class="hljs-string">"local result = redis.call('GET', key)\n"</span> +
        <span class="hljs-string">"return result;"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicReference&lt;String&gt; LUA_SHA = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLua</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    LUA_SHA.compareAndSet(<span class="hljs-keyword">null</span>, COMMANDS.scriptLoad(RAW_LUA));
    String[] keys = <span class="hljs-keyword">new</span> String[]{<span class="hljs-string">"name"</span>};
    String[] args = <span class="hljs-keyword">new</span> String[]{<span class="hljs-string">"throwable"</span>, <span class="hljs-string">"5000"</span>};
    String result = COMMANDS.evalsha(LUA_SHA.get(), ScriptOutputType.VALUE, keys, args);
    log.info(<span class="hljs-string">"Get value:{}"</span>, result);
}
<span class="hljs-comment">// Get value:throwable</span>
</code></pre>
<h2 id="高可用和分片">高可用和分片<a href="#高可用和分片" class="esa-anchor">#</a></h2>
<p>为了<code>Redis</code>的高可用，一般会采用普通主从（<code>Master/Replica</code>，这里笔者称为普通主从模式，也就是仅仅做了主从复制，故障需要手动切换）、哨兵和集群。普通主从模式可以独立运行，也可以配合哨兵运行，只是哨兵提供自动故障转移和主节点提升功能。普通主从和哨兵都可以使用<code>MasterSlave</code>，通过入参包括<code>RedisClient</code>、编码解码器以及一个或者多个<code>RedisURI</code>获取对应的<code>Connection</code>实例。</p>
<p>这里<strong>注意一点</strong>，<code>MasterSlave</code>中提供的方法如果只要求传入一个<code>RedisURI</code>实例，那么<code>Lettuce</code>会进行<strong>拓扑发现机制</strong>，自动获取<code>Redis</code>主从节点信息；如果要求传入一个<code>RedisURI</code>集合，那么对于普通主从模式来说所有节点信息是静态的，不会进行发现和更新。</p>
<p><strong>拓扑发现的规则如下：</strong></p>
<ul>
<li>对于普通主从（<code>Master/Replica</code>）模式，不需要感知<code>RedisURI</code>指向从节点还是主节点，只会进行一次性的拓扑查找所有节点信息，此后节点信息会保存在静态缓存中，不会更新。</li>
<li>对于哨兵模式，会订阅所有哨兵实例并侦听订阅/发布消息以触发拓扑刷新机制，更新缓存的节点信息，也就是哨兵天然就是动态发现节点信息，不支持静态配置。</li>
</ul>
<p>拓扑发现机制的提供<code>API</code>为<code>TopologyProvider</code>，需要了解其原理的可以参考具体的实现。</p>
<p>对于集群（<code>Cluster</code>）模式，<code>Lettuce</code>提供了一套独立的<code>API</code>。</p>
<p>另外，如果<code>Lettuce</code>连接面向的是非单个<code>Redis</code>节点，连接实例提供了<strong>数据读取节点偏好</strong>（<code>ReadFrom</code>）设置，可选值有：</p>
<ul>
<li><code>MASTER</code>：只从<code>Master</code>节点中读取。</li>
<li><code>MASTER_PREFERRED</code>：优先从<code>Master</code>节点中读取。</li>
<li><code>SLAVE_PREFERRED</code>：优先从<code>Slavor</code>节点中读取。</li>
<li><code>SLAVE</code>：只从<code>Slavor</code>节点中读取。</li>
<li><code>NEAREST</code>：使用最近一次连接的<code>Redis</code>实例读取。</li>
</ul>
<h3 id="普通主从模式">普通主从模式<a href="#普通主从模式" class="esa-anchor">#</a></h3>
<p>假设现在有三个<code>Redis</code>服务形成树状主从关系如下：</p>
<ul>
<li>节点一：localhost:6379，角色为Master。</li>
<li>节点二：localhost:6380，角色为Slavor，节点一的从节点。</li>
<li>节点三：localhost:6381，角色为Slavor，节点二的从节点。</li>
</ul>
<p>首次动态节点发现主从模式的节点信息需要如下构建连接：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDynamicReplica</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-comment">// 这里只需要配置一个节点的连接信息，不一定需要是主节点的信息，从节点也可以</span>
    RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"localhost"</span>).withPort(<span class="hljs-number">6379</span>).build();
    RedisClient redisClient = RedisClient.create(uri);
    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, <span class="hljs-keyword">new</span> Utf8StringCodec(), uri);
    <span class="hljs-comment">// 只从从节点读取数据</span>
    connection.setReadFrom(ReadFrom.SLAVE);
    <span class="hljs-comment">// 执行其他Redis命令</span>
    connection.close();
    redisClient.shutdown();
}
</code></pre>
<p>如果需要指定静态的<code>Redis</code>主从节点连接属性，那么可以这样构建连接：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStaticReplica</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    List&lt;RedisURI&gt; uris = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    RedisURI uri1 = RedisURI.builder().withHost(<span class="hljs-string">"localhost"</span>).withPort(<span class="hljs-number">6379</span>).build();
    RedisURI uri2 = RedisURI.builder().withHost(<span class="hljs-string">"localhost"</span>).withPort(<span class="hljs-number">6380</span>).build();
    RedisURI uri3 = RedisURI.builder().withHost(<span class="hljs-string">"localhost"</span>).withPort(<span class="hljs-number">6381</span>).build();
    uris.add(uri1);
    uris.add(uri2);
    uris.add(uri3);
    RedisClient redisClient = RedisClient.create();
    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient,
            <span class="hljs-keyword">new</span> Utf8StringCodec(), uris);
    <span class="hljs-comment">// 只从主节点读取数据</span>
    connection.setReadFrom(ReadFrom.MASTER);
    <span class="hljs-comment">// 执行其他Redis命令</span>
    connection.close();
    redisClient.shutdown();
}
</code></pre>
<h3 id="哨兵模式">哨兵模式<a href="#哨兵模式" class="esa-anchor" style="opacity: 0;">#</a></h3>
<p>由于<code>Lettuce</code>自身提供了哨兵的拓扑发现机制，所以只需要随便配置一个哨兵节点的<code>RedisURI</code>实例即可：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDynamicSentinel</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withPassword(<span class="hljs-string">"你的密码"</span>)
            .withSentinel(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">26379</span>)
            .withSentinelMasterId(<span class="hljs-string">"哨兵Master的ID"</span>)
            .build();
    RedisClient redisClient = RedisClient.create();
    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, <span class="hljs-keyword">new</span> Utf8StringCodec(), redisUri);
    <span class="hljs-comment">// 只允许从从节点读取数据</span>
    connection.setReadFrom(ReadFrom.SLAVE);
    RedisCommands&lt;String, String&gt; command = connection.sync();
    SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
    command.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs);
    String value = command.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value:{}"</span>, value);
}
<span class="hljs-comment">// Get value:throwable</span>
</code></pre>
<h3 id="集群模式">集群模式<a href="#集群模式" class="esa-anchor">#</a></h3>
<p>鉴于笔者对<code>Redis</code>集群模式并不熟悉，<code>Cluster</code>模式下的<code>API</code>使用本身就有比较多的限制，所以这里只简单介绍一下怎么用。先说几个特性：</p>
<p><strong>下面的API提供跨槽位（<code>Slot</code>）调用的功能</strong>：</p>
<ul>
<li><code>RedisAdvancedClusterCommands</code>。</li>
<li><code>RedisAdvancedClusterAsyncCommands</code>。</li>
<li><code>RedisAdvancedClusterReactiveCommands</code>。</li>
</ul>
<p><strong>静态节点选择功能：</strong></p>
<ul>
<li><code>masters</code>：选择所有主节点执行命令。</li>
<li><code>slaves</code>：选择所有从节点执行命令，其实就是只读模式。</li>
<li><code>all nodes</code>：命令可以在所有节点执行。</li>
</ul>
<p><strong>集群拓扑视图动态更新功能：</strong></p>
<ul>
<li>手动更新，主动调用<code>RedisClusterClient#reloadPartitions()</code>。</li>
<li>后台定时更新。</li>
<li>自适应更新，基于连接断开和<code>MOVED/ASK</code>命令重定向自动更新。</li>
</ul>
<p><code>Redis</code>集群搭建详细过程可以参考官方文档，假设已经搭建好集群如下（<code>192.168.56.200</code>是笔者的虚拟机Host）：</p>
<ul>
<li>192.168.56.200:7001 =&gt; 主节点，槽位0-5460。</li>
<li>192.168.56.200:7002 =&gt; 主节点，槽位5461-10922。</li>
<li>192.168.56.200:7003 =&gt; 主节点，槽位10923-16383。</li>
<li>192.168.56.200:7004 =&gt; 7001的从节点。</li>
<li>192.168.56.200:7005 =&gt; 7002的从节点。</li>
<li>192.168.56.200:7006 =&gt; 7003的从节点。</li>
</ul>
<p>简单的集群连接和使用方式如下：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncCluster</span><span class="hljs-params">()</span></span>{
    RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"192.168.56.200"</span>).build();
    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);
    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();
    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();
    commands.setex(<span class="hljs-string">"name"</span>,<span class="hljs-number">10</span>, <span class="hljs-string">"throwable"</span>);
    String value = commands.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value:{}"</span>, value);
}
<span class="hljs-comment">// Get value:throwable</span>
</code></pre>
<p>节点选择：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSyncNodeSelection</span><span class="hljs-params">()</span> </span>{
    RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"192.168.56.200"</span>).withPort(<span class="hljs-number">7001</span>).build();
    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);
    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();
    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();
<span class="hljs-comment">//  commands.all();  // 所有节点</span>
<span class="hljs-comment">//  commands.masters();  // 主节点</span>
    <span class="hljs-comment">// 从节点只读</span>
    NodeSelection&lt;String, String&gt; replicas = commands.slaves();
    NodeSelectionCommands&lt;String, String&gt; nodeSelectionCommands = replicas.commands();
    <span class="hljs-comment">// 这里只是演示,一般应该禁用keys *命令</span>
    Executions&lt;List&lt;String&gt;&gt; keys = nodeSelectionCommands.keys(<span class="hljs-string">"*"</span>);
    keys.forEach(key -&gt; log.info(<span class="hljs-string">"key: {}"</span>, key));
    connection.close();
    redisClusterClient.shutdown();
}
</code></pre>
<p>定时更新集群拓扑视图（每隔十分钟更新一次，这个时间自行考量，不能太频繁）：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPeriodicClusterTopology</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"192.168.56.200"</span>).withPort(<span class="hljs-number">7001</span>).build();
    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);
    ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions
            .builder()
            .enablePeriodicRefresh(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.MINUTES))
            .build();
    redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build());
    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();
    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();
    commands.setex(<span class="hljs-string">"name"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"throwable"</span>);
    String value = commands.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value:{}"</span>, value);
    Thread.sleep(Integer.MAX_VALUE);
    connection.close();
    redisClusterClient.shutdown();
}
</code></pre>
<p>自适应更新集群拓扑视图：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAdaptiveClusterTopology</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI uri = RedisURI.builder().withHost(<span class="hljs-string">"192.168.56.200"</span>).withPort(<span class="hljs-number">7001</span>).build();
    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);
    ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions.builder()
            .enableAdaptiveRefreshTrigger(
                    ClusterTopologyRefreshOptions.RefreshTrigger.MOVED_REDIRECT,
                    ClusterTopologyRefreshOptions.RefreshTrigger.PERSISTENT_RECONNECTS
            )
            .adaptiveRefreshTriggersTimeout(Duration.of(<span class="hljs-number">30</span>, ChronoUnit.SECONDS))
            .build();
    redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build());
    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();
    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();
    commands.setex(<span class="hljs-string">"name"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"throwable"</span>);
    String value = commands.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value:{}"</span>, value);
    Thread.sleep(Integer.MAX_VALUE);
    connection.close();
    redisClusterClient.shutdown();
}
</code></pre>
<h2 id="动态命令和自定义命令">动态命令和自定义命令<a href="#动态命令和自定义命令" class="esa-anchor">#</a></h2>
<p>自定义命令是<code>Redis</code>命令有限集，不过可以更细粒度指定<code>KEY</code>、<code>ARGV</code>、命令类型、编码解码器和返回值类型，依赖于<code>dispatch()</code>方法：</p>
<pre><code class="language-java hljs"><span class="hljs-comment">// 自定义实现PING方法</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCustomPing</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);
    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();
    RedisCommands&lt;String, String&gt; sync = connect.sync();
    RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8;
    String result = sync.dispatch(CommandType.PING, <span class="hljs-keyword">new</span> StatusOutput&lt;&gt;(codec));
    log.info(<span class="hljs-string">"PING:{}"</span>, result);
    connect.close();
    redisClient.shutdown();
}
<span class="hljs-comment">// PING:PONG</span>

<span class="hljs-comment">// 自定义实现Set方法</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCustomSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);
    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();
    RedisCommands&lt;String, String&gt; sync = connect.sync();
    RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8;
    sync.dispatch(CommandType.SETEX, <span class="hljs-keyword">new</span> StatusOutput&lt;&gt;(codec),
            <span class="hljs-keyword">new</span> CommandArgs&lt;&gt;(codec).addKey(<span class="hljs-string">"name"</span>).add(<span class="hljs-number">5</span>).addValue(<span class="hljs-string">"throwable"</span>));
    String result = sync.get(<span class="hljs-string">"name"</span>);
    log.info(<span class="hljs-string">"Get value:{}"</span>, result);
    connect.close();
    redisClient.shutdown();
}
<span class="hljs-comment">// Get value:throwable</span>
</code></pre>
<p>动态命令是基于<code>Redis</code>命令有限集，并且通过注解和动态代理完成一些复杂命令组合的实现。主要注解在<code>io.lettuce.core.dynamic.annotation</code>包路径下。简单举个例子：</p>
<pre><code class="language-java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Commands</span> </span>{

    <span class="hljs-comment">// SET [key] [value]</span>
    <span class="hljs-meta">@Command("SET ?0 ?1")</span>
    <span class="hljs-function">String <span class="hljs-title">setKey</span><span class="hljs-params">(String key, String value)</span></span>;

    <span class="hljs-comment">// SET [key] [value]</span>
    <span class="hljs-meta">@Command("SET :key :value")</span>
    <span class="hljs-function">String <span class="hljs-title">setKeyNamed</span><span class="hljs-params">(<span class="hljs-meta">@Param("key")</span> String key, <span class="hljs-meta">@Param("value")</span> String value)</span></span>;

    <span class="hljs-comment">// MGET [key1] [key2]</span>
    <span class="hljs-meta">@Command("MGET ?0 ?1")</span>
    <span class="hljs-function">List&lt;String&gt; <span class="hljs-title">mGet</span><span class="hljs-params">(String key1, String key2)</span></span>;
    <span class="hljs-comment">/**
     * 方法名作为命令
     */</span>
    <span class="hljs-meta">@CommandNaming(strategy = CommandNaming.Strategy.METHOD_NAME)</span>
    <span class="hljs-function">String <span class="hljs-title">mSet</span><span class="hljs-params">(String key1, String value1, String key2, String value2)</span></span>;
}


<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCustomDynamicSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);
    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();
    RedisCommandFactory commandFactory = <span class="hljs-keyword">new</span> RedisCommandFactory(connect);
    CustomCommand commands = commandFactory.getCommands(CustomCommand.class);
    commands.setKey(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>);
    commands.setKeyNamed(<span class="hljs-string">"throwable"</span>, <span class="hljs-string">"doge"</span>);
    log.info(<span class="hljs-string">"MGET ===&gt; "</span> + commands.mGet(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>));
    commands.mSet(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>,<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>);
    log.info(<span class="hljs-string">"MGET ===&gt; "</span> + commands.mGet(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"key2"</span>));
    connect.close();
    redisClient.shutdown();
}
<span class="hljs-comment">// MGET ===&gt; [throwable, doge]</span>
<span class="hljs-comment">// MGET ===&gt; [value1, value2]</span>
</code></pre>
<h2 id="高阶特性">高阶特性<a href="#高阶特性" class="esa-anchor">#</a></h2>
<p><code>Lettuce</code>有很多高阶使用特性，这里只列举个人认为常用的两点：</p>
<ul>
<li>配置客户端资源。</li>
<li>使用连接池。</li>
</ul>
<p>更多其他特性可以自行参看官方文档。</p>
<h3 id="配置客户端资源">配置客户端资源<a href="#配置客户端资源" class="esa-anchor">#</a></h3>
<p>客户端资源的设置与<code>Lettuce</code>的性能、并发和事件处理相关。线程池或者线程组相关配置占据客户端资源配置的大部分（<code>EventLoopGroups</code>和<code>EventExecutorGroup</code>），这些线程池或者线程组是连接程序的基础组件。一般情况下，客户端资源应该在多个<code>Redis</code>客户端之间共享，并且在不再使用的时候需要自行关闭。笔者认为，客户端资源是面向<code>Netty</code>的。<strong>注意</strong>：<font color="red">除非特别熟悉或者花长时间去测试调整下面提到的参数，否则在没有经验的前提下凭直觉修改默认值，有可能会踩坑</font>。</p>
<p>客户端资源接口是<code>ClientResources</code>，实现类是<code>DefaultClientResources</code>。</p>
<p>构建<code>DefaultClientResources</code>实例：</p>
<pre><code class="language-java hljs"><span class="hljs-comment">// 默认</span>
ClientResources resources = DefaultClientResources.create();

<span class="hljs-comment">// 建造器</span>
ClientResources resources = DefaultClientResources.builder()
                        .ioThreadPoolSize(<span class="hljs-number">4</span>)
                        .computationThreadPoolSize(<span class="hljs-number">4</span>)
                        .build()
</code></pre>
<p>使用：</p>
<pre><code class="language-java hljs">ClientResources resources = DefaultClientResources.create();
<span class="hljs-comment">// 非集群</span>
RedisClient client = RedisClient.create(resources, uri);
<span class="hljs-comment">// 集群</span>
RedisClusterClient clusterClient = RedisClusterClient.create(resources, uris);
<span class="hljs-comment">// ......</span>
client.shutdown();
clusterClient.shutdown();
<span class="hljs-comment">// 关闭资源</span>
resources.shutdown();
</code></pre>
<p><strong>客户端资源基本配置：</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center">属性</th>
<th style="text-align: center">描述</th>
<th style="text-align: center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><code>ioThreadPoolSize</code></td>
<td style="text-align: center"><code>I/O</code>线程数</td>
<td style="text-align: center"><code>Runtime.getRuntime().availableProcessors()</code></td>
</tr>
<tr>
<td style="text-align: center"><code>computationThreadPoolSize</code></td>
<td style="text-align: center">任务线程数</td>
<td style="text-align: center"><code>Runtime.getRuntime().availableProcessors()</code></td>
</tr>
</tbody>
</table>
<p><strong>客户端资源高级配置：</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center">属性</th>
<th style="text-align: center">描述</th>
<th style="text-align: center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><code>eventLoopGroupProvider</code></td>
<td style="text-align: center"><code>EventLoopGroup</code>提供商</td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>eventExecutorGroupProvider</code></td>
<td style="text-align: center"><code>EventExecutorGroup</code>提供商</td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>eventBus</code></td>
<td style="text-align: center">事件总线</td>
<td style="text-align: center"><code>DefaultEventBus</code></td>
</tr>
<tr>
<td style="text-align: center"><code>commandLatencyCollectorOptions</code></td>
<td style="text-align: center">命令延时收集器配置</td>
<td style="text-align: center"><code>DefaultCommandLatencyCollectorOptions</code></td>
</tr>
<tr>
<td style="text-align: center"><code>commandLatencyCollector</code></td>
<td style="text-align: center">命令延时收集器</td>
<td style="text-align: center"><code>DefaultCommandLatencyCollector</code></td>
</tr>
<tr>
<td style="text-align: center"><code>commandLatencyPublisherOptions</code></td>
<td style="text-align: center">命令延时发布器配置</td>
<td style="text-align: center"><code>DefaultEventPublisherOptions</code></td>
</tr>
<tr>
<td style="text-align: center"><code>dnsResolver</code></td>
<td style="text-align: center"><code>DNS</code>处理器</td>
<td style="text-align: center">JDK或者<code>Netty</code>提供</td>
</tr>
<tr>
<td style="text-align: center"><code>reconnectDelay</code></td>
<td style="text-align: center">重连延时配置</td>
<td style="text-align: center"><code>Delay.exponential()</code></td>
</tr>
<tr>
<td style="text-align: center"><code>nettyCustomizer</code></td>
<td style="text-align: center"><code>Netty</code>自定义配置器</td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>tracing</code></td>
<td style="text-align: center">轨迹记录器</td>
<td style="text-align: center">-</td>
</tr>
</tbody>
</table>
<p><strong>非集群客户端<code>RedisClient</code>的属性配置：</strong></p>
<p><code>Redis</code>非集群客户端<code>RedisClient</code>本身提供了配置属性方法：</p>
<pre><code class="language-java hljs">RedisClient client = RedisClient.create(uri);
client.setOptions(ClientOptions.builder()
                       .autoReconnect(<span class="hljs-keyword">false</span>)
                       .pingBeforeActivateConnection(<span class="hljs-keyword">true</span>)
                       .build());
</code></pre>
<p>非集群客户端的配置属性列表：</p>
<table>
<thead>
<tr>
<th style="text-align: center">属性</th>
<th style="text-align: center">描述</th>
<th style="text-align: center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><code>pingBeforeActivateConnection</code></td>
<td style="text-align: center">连接激活之前是否执行<code>PING</code>命令</td>
<td style="text-align: center">false</td>
</tr>
<tr>
<td style="text-align: center"><code>autoReconnect</code></td>
<td style="text-align: center">是否自动重连</td>
<td style="text-align: center">true</td>
</tr>
<tr>
<td style="text-align: center"><code>cancelCommandsOnReconnectFailure</code></td>
<td style="text-align: center">重连失败是否拒绝命令执行</td>
<td style="text-align: center">false</td>
</tr>
<tr>
<td style="text-align: center"><code>suspendReconnectOnProtocolFailure</code></td>
<td style="text-align: center">底层协议失败是否挂起重连操作</td>
<td style="text-align: center">false</td>
</tr>
<tr>
<td style="text-align: center"><code>requestQueueSize</code></td>
<td style="text-align: center">请求队列容量</td>
<td style="text-align: center">2147483647(Integer#MAX_VALUE)</td>
</tr>
<tr>
<td style="text-align: center"><code>disconnectedBehavior</code></td>
<td style="text-align: center">失去连接时候的行为</td>
<td style="text-align: center"><code>DEFAULT</code></td>
</tr>
<tr>
<td style="text-align: center"><code>sslOptions</code></td>
<td style="text-align: center"><code>SSL配置</code></td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>socketOptions</code></td>
<td style="text-align: center"><code>Socket</code>配置</td>
<td style="text-align: center"><code>10 seconds Connection-Timeout, no keep-alive, no TCP noDelay</code></td>
</tr>
<tr>
<td style="text-align: center"><code>timeoutOptions</code></td>
<td style="text-align: center">超时配置</td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>publishOnScheduler</code></td>
<td style="text-align: center">发布反应式信号数据的调度器</td>
<td style="text-align: center">使用<code>I/O</code>线程</td>
</tr>
</tbody>
</table>
<p><strong>集群客户端属性配置：</strong></p>
<p><code>Redis</code>集群客户端<code>RedisClusterClient</code>本身提供了配置属性方法：</p>
<pre><code class="language-java hljs">RedisClusterClient client = RedisClusterClient.create(uri);
ClusterTopologyRefreshOptions topologyRefreshOptions = ClusterTopologyRefreshOptions.builder()
                .enablePeriodicRefresh(refreshPeriod(<span class="hljs-number">10</span>, TimeUnit.MINUTES))
                .enableAllAdaptiveRefreshTriggers()
                .build();

client.setOptions(ClusterClientOptions.builder()
                       .topologyRefreshOptions(topologyRefreshOptions)
                       .build());
</code></pre>
<p>集群客户端的配置属性列表：</p>
<table>
<thead>
<tr>
<th style="text-align: center">属性</th>
<th style="text-align: center">描述</th>
<th style="text-align: center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center"><code>enablePeriodicRefresh</code></td>
<td style="text-align: center">是否允许周期性更新集群拓扑视图</td>
<td style="text-align: center">false</td>
</tr>
<tr>
<td style="text-align: center"><code>refreshPeriod</code></td>
<td style="text-align: center">更新集群拓扑视图周期</td>
<td style="text-align: center">60秒</td>
</tr>
<tr>
<td style="text-align: center"><code>enableAdaptiveRefreshTrigger</code></td>
<td style="text-align: center">设置自适应更新集群拓扑视图触发器<code>RefreshTrigger</code></td>
<td style="text-align: center">-</td>
</tr>
<tr>
<td style="text-align: center"><code>adaptiveRefreshTriggersTimeout</code></td>
<td style="text-align: center">自适应更新集群拓扑视图触发器超时设置</td>
<td style="text-align: center">30秒</td>
</tr>
<tr>
<td style="text-align: center"><code>refreshTriggersReconnectAttempts</code></td>
<td style="text-align: center">自适应更新集群拓扑视图触发重连次数</td>
<td style="text-align: center">5</td>
</tr>
<tr>
<td style="text-align: center"><code>dynamicRefreshSources</code></td>
<td style="text-align: center">是否允许动态刷新拓扑资源</td>
<td style="text-align: center">true</td>
</tr>
<tr>
<td style="text-align: center"><code>closeStaleConnections</code></td>
<td style="text-align: center">是否允许关闭陈旧的连接</td>
<td style="text-align: center">true</td>
</tr>
<tr>
<td style="text-align: center"><code>maxRedirects</code></td>
<td style="text-align: center">集群重定向次数上限</td>
<td style="text-align: center">5</td>
</tr>
<tr>
<td style="text-align: center"><code>validateClusterNodeMembership</code></td>
<td style="text-align: center">是否校验集群节点的成员关系</td>
<td style="text-align: center">true</td>
</tr>
</tbody>
</table>
<h3 id="使用连接池">使用连接池<a href="#使用连接池" class="esa-anchor">#</a></h3>
<p>引入连接池依赖<code>commons-pool2</code>：</p>
<pre><code class="language-xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>
</span></code></pre>
<p>基本使用如下：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUseConnectionPool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    RedisURI redisUri = RedisURI.builder()
            .withHost(<span class="hljs-string">"localhost"</span>)
            .withPort(<span class="hljs-number">6379</span>)
            .withTimeout(Duration.of(<span class="hljs-number">10</span>, ChronoUnit.SECONDS))
            .build();
    RedisClient redisClient = RedisClient.create(redisUri);
    GenericObjectPoolConfig poolConfig = <span class="hljs-keyword">new</span> GenericObjectPoolConfig();
    GenericObjectPool&lt;StatefulRedisConnection&lt;String, String&gt;&gt; pool
            = ConnectionPoolSupport.createGenericObjectPool(redisClient::connect, poolConfig);
    <span class="hljs-keyword">try</span> (StatefulRedisConnection&lt;String, String&gt; connection = pool.borrowObject()) {
        RedisCommands&lt;String, String&gt; command = connection.sync();
        SetArgs setArgs = SetArgs.Builder.nx().ex(<span class="hljs-number">5</span>);
        command.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"throwable"</span>, setArgs);
        String n = command.get(<span class="hljs-string">"name"</span>);
        log.info(<span class="hljs-string">"Get value:{}"</span>, n);
    }
    pool.close();
    redisClient.shutdown();
}
</code></pre>
<p>其中，同步连接的池化支持需要用<code>ConnectionPoolSupport</code>，异步连接的池化支持需要用<code>AsyncConnectionPoolSupport</code>（<code>Lettuce</code>5.1之后才支持）。</p>
<h2 id="几个常见的渐进式删除例子">几个常见的渐进式删除例子<a href="#几个常见的渐进式删除例子" class="esa-anchor">#</a></h2>
<p><strong>渐进式删除Hash中的域-属性：</strong></p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelBigHashKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-comment">// SCAN参数</span>
    ScanArgs scanArgs = ScanArgs.Builder.limit(<span class="hljs-number">2</span>);
    <span class="hljs-comment">// TEMP游标</span>
    ScanCursor cursor = ScanCursor.INITIAL;
    <span class="hljs-comment">// 目标KEY</span>
    String key = <span class="hljs-string">"BIG_HASH_KEY"</span>;
    prepareHashTestData(key);
    log.info(<span class="hljs-string">"开始渐进式删除Hash的元素..."</span>);
    <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        MapScanCursor&lt;String, String&gt; result = COMMAND.hscan(key, cursor, scanArgs);
        <span class="hljs-comment">// 重置TEMP游标</span>
        cursor = ScanCursor.of(result.getCursor());
        cursor.setFinished(result.isFinished());
        Collection&lt;String&gt; fields = result.getMap().values();
        <span class="hljs-keyword">if</span> (!fields.isEmpty()) {
            COMMAND.hdel(key, fields.toArray(<span class="hljs-keyword">new</span> String[<span class="hljs-number">0</span>]));
        }
        counter++;
    } <span class="hljs-keyword">while</span> (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));
    log.info(<span class="hljs-string">"渐进式删除Hash的元素完毕,迭代次数:{} ..."</span>, counter);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareHashTestData</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    COMMAND.hset(key, <span class="hljs-string">"1"</span>, <span class="hljs-string">"1"</span>);
    COMMAND.hset(key, <span class="hljs-string">"2"</span>, <span class="hljs-string">"2"</span>);
    COMMAND.hset(key, <span class="hljs-string">"3"</span>, <span class="hljs-string">"3"</span>);
    COMMAND.hset(key, <span class="hljs-string">"4"</span>, <span class="hljs-string">"4"</span>);
    COMMAND.hset(key, <span class="hljs-string">"5"</span>, <span class="hljs-string">"5"</span>);
}
</code></pre>
<p><strong>渐进式删除集合中的元素：</strong></p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelBigSetKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    String key = <span class="hljs-string">"BIG_SET_KEY"</span>;
    prepareSetTestData(key);
    <span class="hljs-comment">// SCAN参数</span>
    ScanArgs scanArgs = ScanArgs.Builder.limit(<span class="hljs-number">2</span>);
    <span class="hljs-comment">// TEMP游标</span>
    ScanCursor cursor = ScanCursor.INITIAL;
    log.info(<span class="hljs-string">"开始渐进式删除Set的元素..."</span>);
    <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        ValueScanCursor&lt;String&gt; result = COMMAND.sscan(key, cursor, scanArgs);
        <span class="hljs-comment">// 重置TEMP游标</span>
        cursor = ScanCursor.of(result.getCursor());
        cursor.setFinished(result.isFinished());
        List&lt;String&gt; values = result.getValues();
        <span class="hljs-keyword">if</span> (!values.isEmpty()) {
            COMMAND.srem(key, values.toArray(<span class="hljs-keyword">new</span> String[<span class="hljs-number">0</span>]));
        }
        counter++;
    } <span class="hljs-keyword">while</span> (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));
    log.info(<span class="hljs-string">"渐进式删除Set的元素完毕,迭代次数:{} ..."</span>, counter);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareSetTestData</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    COMMAND.sadd(key, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>, <span class="hljs-string">"4"</span>, <span class="hljs-string">"5"</span>);
}
</code></pre>
<p><strong>渐进式删除有序集合中的元素：</strong></p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelBigZSetKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-comment">// SCAN参数</span>
    ScanArgs scanArgs = ScanArgs.Builder.limit(<span class="hljs-number">2</span>);
    <span class="hljs-comment">// TEMP游标</span>
    ScanCursor cursor = ScanCursor.INITIAL;
    <span class="hljs-comment">// 目标KEY</span>
    String key = <span class="hljs-string">"BIG_ZSET_KEY"</span>;
    prepareZSetTestData(key);
    log.info(<span class="hljs-string">"开始渐进式删除ZSet的元素..."</span>);
    <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        ScoredValueScanCursor&lt;String&gt; result = COMMAND.zscan(key, cursor, scanArgs);
        <span class="hljs-comment">// 重置TEMP游标</span>
        cursor = ScanCursor.of(result.getCursor());
        cursor.setFinished(result.isFinished());
        List&lt;ScoredValue&lt;String&gt;&gt; scoredValues = result.getValues();
        <span class="hljs-keyword">if</span> (!scoredValues.isEmpty()) {
            COMMAND.zrem(key, scoredValues.stream().map(ScoredValue&lt;String&gt;::getValue).toArray(String[]::<span class="hljs-keyword">new</span>));
        }
        counter++;
    } <span class="hljs-keyword">while</span> (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));
    log.info(<span class="hljs-string">"渐进式删除ZSet的元素完毕,迭代次数:{} ..."</span>, counter);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareZSetTestData</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    COMMAND.zadd(key, <span class="hljs-number">0</span>, <span class="hljs-string">"1"</span>);
    COMMAND.zadd(key, <span class="hljs-number">0</span>, <span class="hljs-string">"2"</span>);
    COMMAND.zadd(key, <span class="hljs-number">0</span>, <span class="hljs-string">"3"</span>);
    COMMAND.zadd(key, <span class="hljs-number">0</span>, <span class="hljs-string">"4"</span>);
    COMMAND.zadd(key, <span class="hljs-number">0</span>, <span class="hljs-string">"5"</span>);
}
</code></pre>
<h2 id="在springboot中使用lettuce">在SpringBoot中使用Lettuce<a href="#在springboot中使用lettuce" class="esa-anchor">#</a></h2>
<p>个人认为，<code>spring-data-redis</code>中的<code>API</code>封装并不是很优秀，用起来比较重，不够灵活，这里结合前面的例子和代码，在<code>SpringBoot</code>脚手架项目中配置和整合<code>Lettuce</code>。先引入依赖：</p>
<pre><code class="language-xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.lettuce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lettuce-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>        
</code></pre>
<p>一般情况下，每个应用应该使用单个<code>Redis</code>客户端实例和单个连接实例，这里设计一个脚手架，适配单机、普通主从、哨兵和集群四种使用场景。对于客户端资源，采用默认的实现即可。对于<code>Redis</code>的连接属性，比较主要的有<code>Host</code>、<code>Port</code>和<code>Password</code>，其他可以暂时忽略。基于约定大于配置的原则，先定制一系列属性配置类（其实有些配置是可以完全共用，但是考虑到要清晰描述类之间的关系，这里拆分多个配置属性类和多个配置方法）：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "lettuce")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceProperties</span> </span>{

    <span class="hljs-keyword">private</span> LettuceSingleProperties single;
    <span class="hljs-keyword">private</span> LettuceReplicaProperties replica;
    <span class="hljs-keyword">private</span> LettuceSentinelProperties sentinel;
    <span class="hljs-keyword">private</span> LettuceClusterProperties cluster;

}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceSingleProperties</span> </span>{

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> Integer port;
    <span class="hljs-keyword">private</span> String password;
}

<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceReplicaProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LettuceSingleProperties</span> </span>{

}

<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceSentinelProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LettuceSingleProperties</span> </span>{

    <span class="hljs-keyword">private</span> String masterId;
}

<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceClusterProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LettuceSingleProperties</span> </span>{

}
</code></pre>
<p>配置类如下，主要使用<code>@ConditionalOnProperty</code>做隔离，一般情况下，很少有人会在一个应用使用一种以上的<code>Redis</code>连接场景：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConditionalOnClass(name = "io.lettuce.core.RedisURI")</span>
<span class="hljs-meta">@EnableConfigurationProperties(value = LettuceProperties.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LettuceAutoConfiguration</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LettuceProperties lettuceProperties;

    <span class="hljs-meta">@Bean(destroyMethod = "shutdown")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientResources <span class="hljs-title">clientResources</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> DefaultClientResources.create();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.single.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisURI <span class="hljs-title">singleRedisUri</span><span class="hljs-params">()</span> </span>{
        LettuceSingleProperties singleProperties = lettuceProperties.getSingle();
        <span class="hljs-keyword">return</span> RedisURI.builder()
                .withHost(singleProperties.getHost())
                .withPort(singleProperties.getPort())
                .withPassword(singleProperties.getPassword())
                .build();
    }

    <span class="hljs-meta">@Bean(destroyMethod = "shutdown")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.single.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisClient <span class="hljs-title">singleRedisClient</span><span class="hljs-params">(ClientResources clientResources, <span class="hljs-meta">@Qualifier("singleRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> RedisClient.create(clientResources, redisUri);
    }

    <span class="hljs-meta">@Bean(destroyMethod = "close")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.single.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StatefulRedisConnection&lt;String, String&gt; <span class="hljs-title">singleRedisConnection</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("singleRedisClient")</span> RedisClient singleRedisClient)</span> </span>{
        <span class="hljs-keyword">return</span> singleRedisClient.connect();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.replica.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisURI <span class="hljs-title">replicaRedisUri</span><span class="hljs-params">()</span> </span>{
        LettuceReplicaProperties replicaProperties = lettuceProperties.getReplica();
        <span class="hljs-keyword">return</span> RedisURI.builder()
                .withHost(replicaProperties.getHost())
                .withPort(replicaProperties.getPort())
                .withPassword(replicaProperties.getPassword())
                .build();
    }

    <span class="hljs-meta">@Bean(destroyMethod = "shutdown")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.replica.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisClient <span class="hljs-title">replicaRedisClient</span><span class="hljs-params">(ClientResources clientResources, <span class="hljs-meta">@Qualifier("replicaRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> RedisClient.create(clientResources, redisUri);
    }

    <span class="hljs-meta">@Bean(destroyMethod = "close")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.replica.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StatefulRedisMasterSlaveConnection&lt;String, String&gt; <span class="hljs-title">replicaRedisConnection</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("replicaRedisClient")</span> RedisClient replicaRedisClient,
                                                                                     <span class="hljs-meta">@Qualifier("replicaRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> MasterSlave.connect(replicaRedisClient, <span class="hljs-keyword">new</span> Utf8StringCodec(), redisUri);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.sentinel.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisURI <span class="hljs-title">sentinelRedisUri</span><span class="hljs-params">()</span> </span>{
        LettuceSentinelProperties sentinelProperties = lettuceProperties.getSentinel();
        <span class="hljs-keyword">return</span> RedisURI.builder()
                .withPassword(sentinelProperties.getPassword())
                .withSentinel(sentinelProperties.getHost(), sentinelProperties.getPort())
                .withSentinelMasterId(sentinelProperties.getMasterId())
                .build();
    }

    <span class="hljs-meta">@Bean(destroyMethod = "shutdown")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.sentinel.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisClient <span class="hljs-title">sentinelRedisClient</span><span class="hljs-params">(ClientResources clientResources, <span class="hljs-meta">@Qualifier("sentinelRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> RedisClient.create(clientResources, redisUri);
    }

    <span class="hljs-meta">@Bean(destroyMethod = "close")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.sentinel.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StatefulRedisMasterSlaveConnection&lt;String, String&gt; <span class="hljs-title">sentinelRedisConnection</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("sentinelRedisClient")</span> RedisClient sentinelRedisClient,
                                                                                      <span class="hljs-meta">@Qualifier("sentinelRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> MasterSlave.connect(sentinelRedisClient, <span class="hljs-keyword">new</span> Utf8StringCodec(), redisUri);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.cluster.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisURI <span class="hljs-title">clusterRedisUri</span><span class="hljs-params">()</span> </span>{
        LettuceClusterProperties clusterProperties = lettuceProperties.getCluster();
        <span class="hljs-keyword">return</span> RedisURI.builder()
                .withHost(clusterProperties.getHost())
                .withPort(clusterProperties.getPort())
                .withPassword(clusterProperties.getPassword())
                .build();
    }

    <span class="hljs-meta">@Bean(destroyMethod = "shutdown")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.cluster.host")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisClusterClient <span class="hljs-title">redisClusterClient</span><span class="hljs-params">(ClientResources clientResources, <span class="hljs-meta">@Qualifier("clusterRedisUri")</span> RedisURI redisUri)</span> </span>{
        <span class="hljs-keyword">return</span> RedisClusterClient.create(clientResources, redisUri);
    }

    <span class="hljs-meta">@Bean(destroyMethod = "close")</span>
    <span class="hljs-meta">@ConditionalOnProperty(name = "lettuce.cluster")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StatefulRedisClusterConnection&lt;String, String&gt; <span class="hljs-title">clusterConnection</span><span class="hljs-params">(RedisClusterClient clusterClient)</span> </span>{
        <span class="hljs-keyword">return</span> clusterClient.connect();
    }
}
</code></pre>
<p>最后为了让<code>IDE</code>识别我们的配置，可以添加<code>IDE</code>亲缘性，<code>/META-INF</code>文件夹下新增一个文件<code>spring-configuration-metadata.json</code>，内容如下：</p>
<pre><code class="language-json hljs">{
  <span class="hljs-attr">"properties"</span>: [
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"lettuce.single"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceSingleProperties"</span>,
      <span class="hljs-attr">"description"</span>: <span class="hljs-string">"单机配置"</span>,
      <span class="hljs-attr">"sourceType"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceProperties"</span>
    },
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"lettuce.replica"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceReplicaProperties"</span>,
      <span class="hljs-attr">"description"</span>: <span class="hljs-string">"主从配置"</span>,
      <span class="hljs-attr">"sourceType"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceProperties"</span>
    },
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"lettuce.sentinel"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceSentinelProperties"</span>,
      <span class="hljs-attr">"description"</span>: <span class="hljs-string">"哨兵配置"</span>,
      <span class="hljs-attr">"sourceType"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceProperties"</span>
    },
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"lettuce.single"</span>,
      <span class="hljs-attr">"type"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceClusterProperties"</span>,
      <span class="hljs-attr">"description"</span>: <span class="hljs-string">"集群配置"</span>,
      <span class="hljs-attr">"sourceType"</span>: <span class="hljs-string">"club.throwable.spring.lettuce.LettuceProperties"</span>
    }
  ]
}
</code></pre>
<p>如果想<code>IDE</code>亲缘性做得更好，可以添加<code>/META-INF/additional-spring-configuration-metadata.json</code>进行更多细节定义。简单使用如下：</p>
<pre><code class="language-java hljs"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisCommandLineRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier("singleRedisConnection")</span>
    <span class="hljs-keyword">private</span> StatefulRedisConnection&lt;String, String&gt; connection;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        RedisCommands&lt;String, String&gt; redisCommands = connection.sync();
        redisCommands.setex(<span class="hljs-string">"name"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"throwable"</span>);
        log.info(<span class="hljs-string">"Get value:{}"</span>, redisCommands.get(<span class="hljs-string">"name"</span>));
    }
}
<span class="hljs-comment">// Get value:throwable</span>
</code></pre>
<h2 id="小结">小结<a href="#小结" class="esa-anchor">#</a></h2>
<p>本文算是基于<code>Lettuce</code>的官方文档，对它的使用进行全方位的分析，包括主要功能、配置都做了一些示例，限于篇幅部分特性和配置细节没有分析。<code>Lettuce</code>已经被<code>spring-data-redis</code>接纳作为官方的<code>Redis</code>客户端驱动，所以值得信赖，它的一些<code>API</code>设计确实比较合理，扩展性高的同时灵活性也高。个人建议，基于<code>Lettuce</code>包自行添加配置到<code>SpringBoot</code>应用用起来会得心应手，毕竟<code>RedisTemplate</code>实在太笨重，而且还屏蔽了<code>Lettuce</code>一些高级特性和灵活的<code>API</code>。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://lettuce.io/core/release/reference/index.html">Lettuce Reference Guide</a></li>
</ul>
<h2 id="链接">链接<a href="#链接" class="esa-anchor" style="opacity: 0;">#</a></h2>
<ul>
<li>Github Page：<a href="http://www.throwable.club/2019/09/28/redis-client-driver-lettuce-usage">http://www.throwable.club/2019/09/28/redis-client-driver-lettuce-usage</a></li>
<li>Coding Page：<a href="http://throwable.coding.me/2019/09/28/redis-client-driver-lettuce-usage">http://throwable.coding.me/2019/09/28/redis-client-driver-lettuce-usage</a></li>
</ul>
<p>（本文完 c-14-d e-a-20190928 最近事太多...）</p>
<p>技术公众号（《Throwable文摘》），不定期推送笔者原创技术文章（绝不抄袭或者转载）：</p>
<p><a href="https://public-1256189093.cos.ap-guangzhou.myqcloud.com/static/wechat-account-logo.png" data-title="" data-alt="" data-lightbox="roadtrip"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/wechat-account-logo.png" alt="" loading="lazy"></a></p>

</div>
<div id="MySignature" style="display: block;"><div class="esa-post-signature"> 
                        <p>作者：
            throwable
        </p> 
                        <p>出处：<a href="https://www.cnblogs.com/throwable/p/11601538.html">https://www.cnblogs.com/throwable/p/11601538.html</a></p> 
                        <p>版权：本文采用「<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际</a>」知识共享许可协议进行许可。</p> 
                        <p>博文来自笔者的个人博客（https://www.throwx.cn）</p> 
                    </div></div>
<div class="clear"></div>
<div id="blog_post_info_block"><div id="BlogPostCategory">
    分类: 
            <a href="https://www.cnblogs.com/throwable/category/1278319.html" target="_blank">Java</a></div>


    <div id="blog_post_info">
                <div class="esa-sponsor">
                    <div class="title">Buy me a cup of coffee ☕.</div>
                    <ul class="box">
                        <li class="paypal"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-paypal"></use></svg></li>
                        <li class="alipay"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-alipay"></use></svg></li>
                        <li class="wechat"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-wechat"></use></svg></li>
                    </ul>
                    <div class="qrshow">
                        <img src="">
                    </div>
                </div>
<div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(11601538,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
        <a id="green_channel_follow" onclick="follow('6a0b4941-a86a-47f8-2b09-08d5c3af5c24');" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/throwable/" target="_blank"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/20200802205316.png" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/throwable/">throwable</a><br>
            <a href="https://home.cnblogs.com/u/throwable/followees/">关注 - 46</a><br>
            <a href="https://home.cnblogs.com/u/throwable/followers/">粉丝 - 109</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow('6a0b4941-a86a-47f8-2b09-08d5c3af5c24');return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(11601538,'Digg')">
        <span class="diggnum" id="digg_count">15</span>
    </div>
    <div class="buryit" onclick="votePost(11601538,'Bury')">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>

<script type="text/javascript">
    currentDiggType = 0;
</script></div>
    <div class="clear"></div>
    <div id="post_next_prev">

    <a href="https://www.cnblogs.com/throwable/p/11267257.html" class="p_n_p_prefix">« </a> 上一篇：    <a href="https://www.cnblogs.com/throwable/p/11267257.html" title="发布于 2019-07-29 23:39">Spring Cloud Gateway、并发编程等等</a>
    <br>
    <a href="https://www.cnblogs.com/throwable/p/11619080.html" class="p_n_p_prefix">» </a> 下一篇：    <a href="https://www.cnblogs.com/throwable/p/11619080.html" title="发布于 2019-10-03 09:13">一个低级错误引发Netty编码解码中文异常</a>

</div>
</div>
            </div>
            <div class="postDesc">posted @ 
<span id="post-date">2019-09-28 09:33</span>&nbsp;
<a href="https://www.cnblogs.com/throwable/">throwable</a>&nbsp;
阅读(<span id="post_view_count">31995</span>)&nbsp;
评论(<span id="post_comment_count">6</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=11601538" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(11601538);return false;">收藏</a></div>
        </div>
	    
	    
    </div><!--end: topics 文章、评论容器-->
</div>
<script src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/highlight.js"></script>
<script>markdown_highlight();</script>
<script>
    var allowComments = true, cb_blogId = 435641, cb_blogApp = 'throwable', cb_blogUserGuid = '6a0b4941-a86a-47f8-2b09-08d5c3af5c24';
    var cb_entryId = 11601538, cb_entryCreatedDate = '2019-09-28 09:33', cb_postType = 1;
    loadViewCount(cb_entryId);
</script>
<a name="!comments"></a>
<div id="blog-comments-placeholder">

<div id="comment_pager_top">
    
</div>

<br>
<div class="feedback_area_title">评论列表</div>
<div class="feedbackNoItems">
    <div class="feedbackNoItems"></div>
</div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4439332" class="layer">#1楼</a>
<a name="4439332" id="comment_anchor_4439332"></a>
 
<span class="comment_date">2019-11-26 13:23</span>

 
        <a id="a_comment_author_4439332" href="https://www.cnblogs.com/smartzhang/" target="_blank">jack_zdl</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://www.cnblogs.com/smartzhang/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/sample_face.gif"></a></div><div id="comment_body_4439332" data-format-type="Ubb" class="blog_comment_body cnblogs-ubb">
    发表评论，好文章
</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4439332, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4439332, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        

        </div>
    </div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4551646" class="layer">#2楼</a>
<a name="4551646" id="comment_anchor_4551646"></a>
 
<span class="comment_date">2020-04-15 22:47</span>

 
        <a id="a_comment_author_4551646" href="https://www.cnblogs.com/upnote/" target="_blank">元思</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://www.cnblogs.com/upnote/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/20200617140229.png"></a></div><div id="comment_body_4551646" data-format-type="Markdown" class="blog_comment_body cnblogs-markdown">
    <p>整理的很详细</p>

</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4551646, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4551646, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        <span id="comment_4551646_avatar" style="display:none">
            https://pic.cnblogs.com/face/1614439/20200617140229.png
        </span>

        </div>
    </div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4553771" class="layer">#3楼</a>
<a name="4553771" id="comment_anchor_4553771"></a>
 
<span class="comment_date">2020-04-18 08:53</span>

 
        <a id="a_comment_author_4553771" href="https://www.cnblogs.com/backnow/" target="_blank">遇见那只猫</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://www.cnblogs.com/backnow/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/20180925225917.png"></a></div><div id="comment_body_4553771" data-format-type="Markdown" class="blog_comment_body cnblogs-markdown">
    <p>这我在博客园见过最长最有诚意的分享了，谢谢博主</p>

</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4553771, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4553771, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        <span id="comment_4553771_avatar" style="display:none">
            https://pic.cnblogs.com/face/639999/20180925225917.png
        </span>

        </div>
    </div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4553821" class="layer">#4楼</a>
<a name="4553821" id="comment_anchor_4553821"></a>
 
<span class="comment_date">2020-04-18 10:16</span>

 
        <a id="a_comment_author_4553821" href="https://www.cnblogs.com/mbky/" target="_blank">混沌初开</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://www.cnblogs.com/mbky/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/20190809135941.png"></a></div><div id="comment_body_4553821" data-format-type="Markdown" class="blog_comment_body cnblogs-markdown">
    <p>翻spring data redis  找到这来的，顶楼主啊</p>

</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4553821, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4553821, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        <span id="comment_4553821_avatar" style="display:none">
            https://pic.cnblogs.com/face/874442/20190809135941.png
        </span>

        </div>
    </div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4567215" class="layer">#5楼</a>
<a name="4567215" id="comment_anchor_4567215"></a>
 
<span class="comment_date">2020-05-04 02:18</span>

 
        <a id="a_comment_author_4567215" href="https://www.cnblogs.com/wgb123/" target="_blank">NG柠檬</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://www.cnblogs.com/wgb123/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/sample_face.gif"></a></div><div id="comment_body_4567215" data-format-type="Markdown" class="blog_comment_body cnblogs-markdown">
    <p>微信搜索Throwable文摘 搜出来一个用户 吓我一跳 hh 搜索下面的公众号才可以</p>

</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4567215, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4567215, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        

        </div>
    </div>
    <div class="feedbackItem">
        <div class="feedbackListSubtitle">
            <div class="feedbackManage">
                &nbsp;&nbsp;

<span class="comment_actions">
    
    
    
    
</span>


            </div>
            
<a href="#4582309" class="layer">#6楼</a>
<a name="4582309" id="comment_anchor_4582309"></a>
    <span id="comment-maxId" style="display: none">4582309</span>
    <span id="comment-maxDate" style="display: none">2020/5/20 下午4:23:31</span>
 
<span class="comment_date">2020-05-20 16:23</span>

 
        <a id="a_comment_author_4582309" href="https://home.cnblogs.com/u/2043211/" target="_blank">miaoguoxin</a>

        </div>
        <div class="feedbackCon">
            
<div class="esa-comment-avatar"><a target="_blank" href="https://home.cnblogs.com/u/2043211/"><img src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/sample_face.gif"></a></div><div id="comment_body_4582309" data-format-type="Markdown" class="blog_comment_body cnblogs-markdown">
    <p>老哥，我的pipeline和你的测试有出入，我用的redisTemplate.executePipelined()，连接是用的lettuce（版本5.2.2），spring-boot版本 2.2.5，测试出来的结果显示：除了第一次建立连接耗时较长<br>
以外，后续操作都是10毫秒以下（连续set 200条字符串）。</p>

</div>
        <div class="comment_vote">
            <span class="comment_error" style="color: red"></span>
            <a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4582309, 'Digg', this.parentElement, false);">
                支持(0)
            </a>
            <a href="javascript:void(0);" class="comment_burry" onclick="return voteComment(4582309, 'Bury', this.parentElement, false);">
                反对(0)
            </a>
        </div>
        

        </div>
    </div>

<div id="comment_pager_bottom">
    
</div>


</div>
<div id="comment_form" class="commentform">
    <a name="commentform"></a>
    <div id="divCommentShow"></div>
    <div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
    <div id="comment_form_container" style="visibility: visible;"><div class="login_tips">
    登录后才能发表评论，立即 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login('commentform');">登录</a> 或
    <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，
    <a href="https://www.cnblogs.com/">访问</a> 网站首页。
</div>
<div class="under-comment-nav under-comment-box-nav">
    <ul>
        <li><a href="https://www.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-sitehome')">首页</a></li>
        <li><a href="https://news.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-news')">新闻</a></li>
        <li><a href="https://q.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-q')">博问</a></li>
        <li><a href="https://brands.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-brands')">专区</a></li>
        <li><a href="https://ing.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-ing')">闪存</a></li>
        <li><a href="https://edu.cnblogs.com/" onclick="ga('send', 'event', 'Link', 'click', 'under-comment-nav-edu')">班级</a></li>
    </ul>
</div></div>
    <div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
    <div id="ad_t2"></div>
    <div id="opt_under_post"></div>
    <div id="cnblogs_c1" class="c_ad_block">
        <div id="div-gpt-ad-1592365906576-0" style="width: 300px; height: 250px;"></div>
    </div>
    <div id="under_post_news"></div>
    <div id="cnblogs_c2" class="c_ad_block">
        <div id="div-gpt-ad-1592366332455-0" style="width: 468px; height: 60px;"></div>
    </div>
    <div id="under_post_kb"></div>
    <div id="HistoryToday" class="c_ad_block"></div>
    <script type="text/javascript">
       var commentManager = new blogCommentManager();
       commentManager.renderComments(0);
       fixPostBody();
       deliverBigBanner();
setTimeout(function() { incrementViewCount(cb_entryId); }, 50);       deliverT2();
       deliverC1C2();
       loadNewsAndKb();
       loadBlogSignature();
LoadPostCategoriesTags(cb_blogId, cb_entryId);       LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
       GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
       loadOptUnderPost();
       GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
   </script>
</div>

	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->
	<div id="sideBar">
		<div id="sideBarMain"><img class="esa-profile-avatar" src="Redis%E9%AB%98%E7%BA%A7%E5%AE%A2%E6%88%B7%E7%AB%AFLettuce%E8%AF%A6%E8%A7%A3%20-%20throwable%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/official-account-qrcode-380.jpg">
			<div id="sidebar_news" class="newsItem"><!--done-->
<h3 class="catListTitle">公告</h3>

<div id="blog-news">
    <script type="text/javascript">window['__document_write_ajax_callbacks__']['5']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['6']();</script><script>window['__document_write_ajax_callbacks__']['1']();</script>
<script type="text/javascript">window['__document_write_ajax_callbacks__']['7']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['2']();</script>
<script type="text/javascript">window['__document_write_ajax_callbacks__']['8']();</script><script>window['__document_write_ajax_callbacks__']['3']();</script>
    <div id="profile_block">
        昵称：
        <a href="https://home.cnblogs.com/u/throwable/">
            throwable
        </a>
        <br>
        园龄：
        <a href="https://home.cnblogs.com/u/throwable/" title="入园时间：2018-05-31">
            2年4个月
        </a>
        <br>
        粉丝：
        <a href="https://home.cnblogs.com/u/throwable/followers/">
            109
        </a>
        <br>
        关注：
        <a href="https://home.cnblogs.com/u/throwable/followees/">
            46
        </a>
        <div id="p_b_follow">
<a href="javascript:void(0)" onclick="follow('6a0b4941-a86a-47f8-2b09-08d5c3af5c24')">+加关注</a></div>
        <script type="text/javascript">window['__document_write_ajax_callbacks__']['9']();</script><script>window['__document_write_ajax_callbacks__']['4']();</script>
    </div>
</div>

</div>
<div id="sidebar_ad"></div>
			<div id="blog-calendar" style="display:none"></div><script>loadBlogDefaultCalendar();</script>			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><!-- 搜索 -->
<div id="sidebar_search" class="sidebar-block">
    <div id="sidebar_search" class="mySearch">
        <h3 class="catListTitle">搜索</h3>
        <div id="sidebar_search_box">
            <div id="widget_my_zzk" class="div_my_zzk">
                <input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk">
            </div>
            
        </div>
    </div>
</div>

<!-- 常用链接 -->


<!-- 最新随笔 -->
<div id="sidebar_recentposts" class="sidebar-block"><div class="catListEssay">
<h3 class="catListTitle">最新随笔</h3>
    <ul>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13834465.html">1.深入理解RabbitMQ中的prefetch_count参数</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13776819.html">2.简化ETL工作，编写一个Canal胶水层</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13656224.html">3.阿里出品Excel工具EasyExcel使用小结</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13617601.html">4.Canalv1.1.4版本搭建HA集群</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13605289.html">5.使用开源文档工具docsify，用写博客的姿势写文档</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13574306.html">6.硬核干货：4W字从源码上分析JUC线程池ThreadPoolExecutor的实现原理</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13473525.html">7.聊聊Java内省Introspector</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13467763.html">8.冷饭新炒：理解Snowflake算法的实现原理</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13449920.html">9.Canal v1.1.4版本避坑指南</a>

                </li>
                <li>
                    
<a href="https://www.cnblogs.com/throwable/p/13439079.html">10.Java线程生命周期与状态切换</a>

                </li>
    </ul>
</div>

</div>

<!-- 我的标签 -->
<div id="sidebar_toptags" class="sidebar-block"><div class="catListTag">
<h3 class="catListTitle">我的标签</h3>
<ul>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/JAVA/">JAVA<span class="tag-count">(7)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程<span class="tag-count">(3)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/IO/">IO<span class="tag-count">(2)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/%E6%B3%A8%E8%A7%A3/">注解<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/Cipher/">Cipher<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/HTTP/">HTTP<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/JCE/">JCE<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/Netflix/">Netflix<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/Spring/">Spring<span class="tag-count">(1)</span></a>
        </li>
        <li>
            <a href="https://www.cnblogs.com/throwable/tag/SpringBoot/">SpringBoot<span class="tag-count">(1)</span></a>
        </li>
    <li>
        <a href="https://www.cnblogs.com/throwable/tag/">更多</a>
    </li>

</ul>
</div>

</div>

<!-- 积分与排名 -->
<div id="sidebar_scorerank" class="sidebar-block"><div class="catListBlogRank">
<h3 class="catListTitle">积分与排名</h3>
<ul>
	<li class="liScore">
		积分 -	
116391
	</li>
	<li class="liRank">
		排名 -	
6722
	</li>
</ul>
</div>



</div>

<!-- 随笔分类、随笔档案、文章分类、新闻分类、相册、链接 -->
<div id="sidebar_categories">
        <div id="sidebar_postcategory" class="catListPostCategory sidebar-block">
            <h3 class="catListTitle">
                
随笔分类
<span style="font-size:11px;font-weight:normal">(114)</span>


            </h3>


            <ul>

                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1786367.html" rel="" target="">
    DevOps(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1278319.html" rel="" target="">
    Java(58)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1230394.html" rel="" target="">
    JAVA奇技淫巧(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1231056.html" rel="" target="">
    JUC(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1478923.html" rel="" target="">
    JVM(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1301913.html" rel="" target="">
    Netflix(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1562242.html" rel="" target="">
    Redis(5)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1625462.html" rel="" target="">
    SOFAStack(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1268912.html" rel="" target="">
    SpringBoot(17)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1259194.html" rel="" target="">
    SpringCloud(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1272182.html" rel="" target="">
    SpringMVC(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1801477.html" rel="" target="">
    架构设计(6)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1254824.html" rel="" target="">
    设计模式(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1230668.html" rel="" target="">
    算法(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/category/1236739.html" rel="" target="">
    网络编程(6)
</a>
 

                        </li>

            </ul>


        </div>
        <div id="sidebar_postarchive" class="catListPostArchive sidebar-block">
            <h3 class="catListTitle">
                
随笔档案
<span style="font-size:11px;font-weight:normal">(96)</span>


            </h3>


            <ul>

                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/10.html" rel="" target="">
    2020年10月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/09.html" rel="" target="">
    2020年9月(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/08.html" rel="" target="">
    2020年8月(6)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/07.html" rel="" target="">
    2020年7月(12)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/06.html" rel="" target="">
    2020年6月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/05.html" rel="" target="">
    2020年5月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/04.html" rel="" target="">
    2020年4月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/03.html" rel="" target="">
    2020年3月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/02.html" rel="" target="">
    2020年2月(15)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2020/01.html" rel="" target="">
    2020年1月(8)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/12.html" rel="" target="">
    2019年12月(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/11.html" rel="" target="">
    2019年11月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/10.html" rel="" target="">
    2019年10月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/09.html" rel="" target="">
    2019年9月(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/07.html" rel="" target="">
    2019年7月(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/06.html" rel="" target="">
    2019年6月(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/05.html" rel="" target="">
    2019年5月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2019/04.html" rel="" target="">
    2019年4月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2018/10.html" rel="" target="">
    2018年10月(6)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2018/09.html" rel="" target="">
    2018年9月(2)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2018/08.html" rel="" target="">
    2018年8月(5)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2018/07.html" rel="" target="">
    2018年7月(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/throwable/archive/2018/06.html" rel="" target="">
    2018年6月(6)
</a>
 

                        </li>

            </ul>


        </div>
</div>

<!-- 最新评论 -->



<!-- 阅读排行榜 -->
<div id="sidebar_topviewedposts" class="sidebar-block"><div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock">
        <ul style="word-break:break-all">
                    <li>
                        <a href="https://www.cnblogs.com/throwable/p/11601538.html">
                            1. Redis高级客户端Lettuce详解(31985)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/throwable/p/9471938.html">
                            2. SpringMVC请求参数和响应结果全局加密和解密(15731)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/throwable/p/9346547.html">
                            3. 基于Prometheus搭建SpringCloud全方位立体监控体系(14799)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/throwable/p/9139947.html">
                            4. JAVA中神奇的双刃剑--Unsafe(13044)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/throwable/p/9434436.html">
                            5. SpringMVC请求参数接收总结(12522)
                        </a>
                    </li>
        </ul>
    </div>
</div>

</div>

<!-- 评论排行榜 -->


<!-- 推荐排行榜 -->
<div id="sidebar_topdiggedposts" class="sidebar-block">
<div id="topdigg_posts_wrap">
    <div class="catListView">
        <h3 class="catListTitle">推荐排行榜</h3>
        <div id="TopDiggPostsBlock">
            <ul style="word-break: break-all">
                        <li>
                            <a href="https://www.cnblogs.com/throwable/p/11601538.html">
                                1. Redis高级客户端Lettuce详解(15)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/throwable/p/13574306.html">
                                2. 硬核干货：4W字从源码上分析JUC线程池ThreadPoolExecutor的实现原理(8)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/throwable/p/13285518.html">
                                3. 百万级别数据Excel导出优化(8)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/throwable/p/9315318.html">
                                4. 设计模式概念和七大原则(6)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/throwable/p/13656224.html">
                                5. 阿里出品Excel工具EasyExcel使用小结(4)
                            </a>
                        </li>
            </ul>
        </div>
    </div>
</div></div></div>
                    <script>loadBlogSideColumn();</script>
			</div>			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		<!--done-->
Copyright © 2020 throwable
<br><span id="poweredby">Powered by .NET 5.0.0-rc.2.20475.5 on Kubernetes</span>



	<span class="esa-copyright">&amp; Theme <a href="https://github.com/esofar/cnblogs-theme-silence" target="_blank">Silence v3.0.0</a></span></div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->


    


<script type="text/javascript">
 $.silence({
    avatar: 'https://public-1256189093.cos.ap-guangzhou.myqcloud.com/static/official-account-qrcode-380.jpg',
    favicon: 'https://files-cdn.cnblogs.com/files/throwable/favicon.ico',
    customNavs: [{
            title: 'Github',
            url: 'https://github.com/zjcscut'
        },
        {
            title: '标签',
            url: 'https://www.cnblogs.com/throwable/tag/'
        },
        {
            title: '归档',
            url: 'https://www.cnblogs.com/throwable/p/'
        },
        {
            title: '公众号',
            url: 'https://mp.weixin.qq.com/s/zRvT46NeCYaJOsHcucro3w'
        },
        {
            title: '个人博客',
            url: 'https://www.throwx.cn'
        }
    ],
    catalog: {
        enable: true,
        move: true,
        index: true,
        level1: 'h2',
        level2: 'h3',
        level3: 'h4',
    },
    signature: {
        enable: true,
        license: '署名-非商业性使用-相同方式共享 4.0 国际',
        link: 'https://creativecommons.org/licenses/by-nc-sa/4.0/',
        remark: '博文来自笔者的个人博客（https://www.throwx.cn）'
    },
    sponsor: {
        enable: true,
        text: 'Buy me a cup of coffee ☕.',
        paypal: null,
        wechat: 'https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/square-wechat.jpg',
        alipay: 'https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/square-alipay.png'
    },
    github: {
        enable: true,
        link: 'https://www.throwx.cn',
        target: '_blank'
    }
});
</script><a href="https://www.throwx.cn/" class="github-corner" title="Fork me on GitHub" target="_blank">
                <svg width="60" height="60" viewBox="0 0 250 250" style=" color:#fff;" aria-hidden="true">
                    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
                </svg>
            </a><div class="esa-toolbar">
        <div class="btn"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-menu1"></use></svg></div>
        <span class="up"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-up"></use></svg></span>
        <span class="down"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-down"></use></svg></span>
        <span class="skin"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-skin"></use></svg></span>
    <span class="contents"><svg class="icon" aria-hidden="true"><use xlink:href="#silence-contents"></use></svg></span></div><div class="esa-contents"><ul><li class="h2" title="前提">
                    <a class="esa-anchor-link" href="#前提"><span class="level1">1. </span>前提</a>
                 </li><li class="h2" title="Lettuce简介">
                    <a class="esa-anchor-link" href="#lettuce简介"><span class="level1">2. </span>Lettuce简介</a>
                 </li><li class="h2" title="连接Redis">
                    <a class="esa-anchor-link" href="#连接redis"><span class="level1">3. </span>连接Redis</a>
                 </li><li class="h3" title="定制的连接URI语法">
                    <a class="esa-anchor-link" href="#定制的连接uri语法"><span class="level2">3.1. </span>定制的连接URI语法</a>
                 </li><li class="h3" title="基本使用">
                    <a class="esa-anchor-link" href="#基本使用"><span class="level2">3.2. </span>基本使用</a>
                 </li><li class="h2" title="API">
                    <a class="esa-anchor-link" href="#api"><span class="level1">4. </span>API</a>
                 </li><li class="h3" title="同步API">
                    <a class="esa-anchor-link" href="#同步api"><span class="level2">4.1. </span>同步API</a>
                 </li><li class="h3" title="异步API">
                    <a class="esa-anchor-link" href="#异步api"><span class="level2">4.2. </span>异步API</a>
                 </li><li class="h3" title="反应式API">
                    <a class="esa-anchor-link" href="#反应式api"><span class="level2">4.3. </span>反应式API</a>
                 </li><li class="h3" title="发布和订阅">
                    <a class="esa-anchor-link" href="#发布和订阅"><span class="level2">4.4. </span>发布和订阅</a>
                 </li><li class="h3" title="事务和批量命令执行">
                    <a class="esa-anchor-link" href="#事务和批量命令执行"><span class="level2">4.5. </span>事务和批量命令执行</a>
                 </li><li class="h3" title="Lua脚本执行">
                    <a class="esa-anchor-link" href="#lua脚本执行"><span class="level2">4.6. </span>Lua脚本执行</a>
                 </li><li class="h2" title="高可用和分片">
                    <a class="esa-anchor-link" href="#高可用和分片"><span class="level1">5. </span>高可用和分片</a>
                 </li><li class="h3" title="普通主从模式">
                    <a class="esa-anchor-link" href="#普通主从模式"><span class="level2">5.1. </span>普通主从模式</a>
                 </li><li class="h3" title="哨兵模式">
                    <a class="esa-anchor-link" href="#哨兵模式"><span class="level2">5.2. </span>哨兵模式</a>
                 </li><li class="h3" title="集群模式">
                    <a class="esa-anchor-link" href="#集群模式"><span class="level2">5.3. </span>集群模式</a>
                 </li><li class="h2" title="动态命令和自定义命令">
                    <a class="esa-anchor-link" href="#动态命令和自定义命令"><span class="level1">6. </span>动态命令和自定义命令</a>
                 </li><li class="h2" title="高阶特性">
                    <a class="esa-anchor-link" href="#高阶特性"><span class="level1">7. </span>高阶特性</a>
                 </li><li class="h3" title="配置客户端资源">
                    <a class="esa-anchor-link" href="#配置客户端资源"><span class="level2">7.1. </span>配置客户端资源</a>
                 </li><li class="h3" title="使用连接池">
                    <a class="esa-anchor-link" href="#使用连接池"><span class="level2">7.2. </span>使用连接池</a>
                 </li><li class="h2" title="几个常见的渐进式删除例子">
                    <a class="esa-anchor-link" href="#几个常见的渐进式删除例子"><span class="level1">8. </span>几个常见的渐进式删除例子</a>
                 </li><li class="h2" title="在SpringBoot中使用Lettuce">
                    <a class="esa-anchor-link" href="#在springboot中使用lettuce"><span class="level1">9. </span>在SpringBoot中使用Lettuce</a>
                 </li><li class="h2" title="小结">
                    <a class="esa-anchor-link" href="#小结"><span class="level1">10. </span>小结</a>
                 </li><li class="h2" title="链接">
                    <a class="esa-anchor-link" href="#链接"><span class="level1">11. </span>链接</a>
                 </li></ul></div><script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4df6907aebab752244c3ca1432b4ff57";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">getFollowStatus('6a0b4941-a86a-47f8-2b09-08d5c3af5c24');</script><div id="lightboxOverlay" tabindex="-1" class="lightboxOverlay" style="display: none;"></div><div id="lightbox" tabindex="-1" class="lightbox" style="display: none;"><div class="lb-outerContainer"><div class="lb-container"><img class="lb-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt=""><div class="lb-nav"><a class="lb-prev" aria-label="Previous image" href=""></a><a class="lb-next" aria-label="Next image" href=""></a></div><div class="lb-loader"><a class="lb-cancel"></a></div></div></div><div class="lb-dataContainer"><div class="lb-data"><div class="lb-details"><span class="lb-caption"></span><span class="lb-number"></span></div><div class="lb-closeContainer"><a class="lb-close"></a></div></div></div></div></body></html>